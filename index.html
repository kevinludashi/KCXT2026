<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>商品库存管理系统 V8.260113.01</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
            touch-action: manipulation;
        }
        
        .container {
            max-width: 100%;
            padding: 10px;
            padding-bottom: 90px;
        }
        
        header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        /* 修复1: 页头内容左对齐 */
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left; /* 改为左对齐 */
        }
        
        h1 {
            font-size: 1.3rem;
            font-weight: 600;
            text-align: left; /* 标题左对齐 */
        }
        
        /* 修复：导航标签横向滚动，不换行 */
        .nav-tabs {
            display: flex;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            position: sticky;
            top: 70px;
            z-index: 99;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }
        
        .nav-tabs::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Edge */
        }
        
        .tab {
            flex: 0 0 auto;
            padding: 12px 15px;
            text-align: center;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        .tab.active {
            color: #2575fc;
            border-bottom-color: #2575fc;
            background-color: rgba(37, 117, 252, 0.05);
        }
        
        .tab i {
            margin-right: 5px;
            font-size: 1rem;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }
        
        .btn {
            padding: 10px 16px;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        .btn-primary {
            background-color: #2575fc;
            color: white;
        }
        
        .btn-primary:hover, .btn-primary:active {
            background-color: #1c64e0;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover, .btn-secondary:active {
            background-color: #5a6268;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:hover, .btn-success:active {
            background-color: #218838;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-danger:hover, .btn-danger:active {
            background-color: #c82333;
        }
        
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        
        .btn-info:hover, .btn-info:active {
            background-color: #138496;
        }
        
        .btn i {
            margin-right: 5px;
            font-size: 0.9rem;
        }
        
        .btn-sm {
            padding: 6px 10px;
            font-size: 0.8rem;
        }
        
        .btn-group {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .action-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .action-dropdown-btn {
            background-color: #f8f9fa;
            color: #495057;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        .action-dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 160px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            z-index: 101;
            right: 0;
            top: 100%;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .action-dropdown-content.show {
            display: block;
        }
        
        .action-dropdown-content a {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            font-size: 0.9rem;
            border-bottom: 1px solid #f1f1f1;
        }
        
        .action-dropdown-content a:hover {
            background-color: #f8f9fa;
        }
        
        .action-dropdown-content a:last-child {
            border-bottom: none;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #555;
            font-size: 0.9rem;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border 0.3s ease;
            -webkit-appearance: none;
        }
        
        .form-control:focus {
            border-color: #2575fc;
            outline: none;
            box-shadow: 0 0 0 2px rgba(37, 117, 252, 0.1);
        }
        
        .form-row {
            display: flex;
            gap: 10px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.85rem;
        }
        
        th {
            background-color: #f8f9fa;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            font-size: 0.85rem;
        }
        
        td {
            padding: 12px 8px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .product-img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .product-img:hover {
            transform: scale(1.05);
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .badge-success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .badge-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .badge-danger {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .badge-info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .badge-secondary {
            background-color: #e2e3e5;
            color: #383d41;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 10px;
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 1;
        }
        
        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-body {
            padding: 15px;
        }
        
        .modal-footer {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            position: sticky;
            bottom: 0;
            background-color: white;
        }
        
        .img-preview-container {
            display: flex;
            justify-content: center;
            margin: 12px 0;
        }
        
        .img-preview {
            max-width: 150px;
            max-height: 150px;
            border-radius: 6px;
            object-fit: contain;
        }
        
        .fullscreen-img {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .fullscreen-img.active {
            display: flex;
        }
        
        .fullscreen-img img {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
        }
        
        .close-fullscreen {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            background: rgba(0,0,0,0.5);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: #999;
        }
        
        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 12px;
            color: #ddd;
        }
        
        .search-box {
            margin-bottom: 15px;
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 12px 10px 40px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23999' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 12px center;
            background-size: 16px;
        }
        
        .clear-search-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .history-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-action {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 0.9rem;
        }
        
        .history-details {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 4px;
        }
        
        .history-time {
            font-size: 0.75rem;
            color: #999;
        }
        
        .stock-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .stock-normal {
            background-color: #28a745;
        }
        
        .stock-low {
            background-color: #ffc107;
        }
        
        .stock-out {
            background-color: #dc3545;
        }
        
        .export-import-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .warning-box {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
        }
        
        .warning-box h4 {
            color: #856404;
            margin-bottom: 8px;
            font-size: 1rem;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: inline-block;
            padding: 8px 14px;
            background-color: #6c757d;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.9rem;
        }
        
        .file-label:hover {
            background-color: #5a6268;
        }
        
        .inventory-group {
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .inventory-group-header {
            background-color: #f8f9fa;
            padding: 12px 15px;
            font-weight: 600;
            color: #495057;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .inventory-group-header i {
            transition: transform 0.3s ease;
        }
        
        .inventory-group-header.collapsed i {
            transform: rotate(-90deg);
        }
        
        .inventory-group-items {
            background-color: white;
            display: block;
        }
        
        .inventory-group-items.collapsed {
            display: none;
        }
        
        .inventory-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f1f1f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .inventory-item:last-child {
            border-bottom: none;
        }
        
        .inventory-item-info {
            flex: 1;
        }
        
        .inventory-item-name {
            font-weight: 500;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
        }
        
        .inventory-item-sku {
            font-size: 0.8rem;
            color: #666;
        }
        
        .inventory-item-stock {
            text-align: right;
            margin-left: 10px;
        }
        
        .inventory-item-quantity {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .inventory-item-status {
            font-size: 0.75rem;
            margin-top: 3px;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .cart-item:last-child {
            border-bottom: none;
        }
        
        .cart-item-info {
            flex: 1;
        }
        
        .cart-item-name {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .cart-item-sku {
            font-size: 0.8rem;
            color: #666;
        }
        
        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .quantity-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid #ddd;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
        }
        
        .quantity-input {
            width: 60px;
            text-align: center;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .filter-section {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .filter-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .filter-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .filter-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .footer-info {
            text-align: center;
            padding: 15px;
            color: #999;
            font-size: 0.8rem;
            background-color: white;
            border-top: 1px solid #eee;
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 99;
        }
        
        .toggle-buttons {
            display: none;
            background-color: white;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .toggle-buttons.active {
            display: block;
        }
        
        .toggle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .toggle-title {
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .toggle-content {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .toggle-btn {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: white;
            text-align: center;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }
        
        .toggle-btn:hover, .toggle-btn:active {
            background-color: #f8f9fa;
            border-color: #2575fc;
        }
        
        .toggle-btn i {
            display: block;
            margin-bottom: 5px;
            font-size: 1.2rem;
            color: #2575fc;
        }
        
        /* 修复2: 悬浮按钮在最上层，不被底部遮挡 */
        .floating-action-btn {
            position: fixed;
            bottom: 100px; /* 提高位置，避免被底部遮挡 */
            right: 15px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: #2575fc;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(37, 117, 252, 0.3);
            cursor: pointer;
            z-index: 1000; /* 提高z-index使其在最上层 */
            font-size: 1.5rem;
        }
        
        /* 新增：产品操作按钮下拉菜单 */
        .product-actions-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .product-actions-btn {
            padding: 6px 10px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .product-actions-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 150px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            z-index: 1000; /* 增加z-index确保在最上层 */
            margin-top: 5px;
        }
        
        .product-actions-content.show {
            display: block;
        }
        
        .product-actions-content button {
            width: 100%;
            padding: 10px 12px;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            border-bottom: 1px solid #f1f1f1;
        }
        
        .product-actions-content button:hover {
            background-color: #f8f9fa;
        }
        
        .product-actions-content button:last-child {
            border-bottom: none;
        }
        
        /* 修复：数据总览样式 - 保持2个一行 */
        .overview-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .overview-stat-item {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .overview-stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .overview-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .overview-stat-label {
            font-size: 0.85rem;
            color: #666;
        }
        
        .overview-chart-container {
            display: none; /* 隐藏图表容器 */
        }
        
        .overview-chart-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        
        .overview-list {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .overview-list-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .overview-list-item {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .overview-list-item:last-child {
            border-bottom: none;
        }
        
        .overview-list-item-info {
            flex: 1;
        }
        
        .overview-list-item-name {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .overview-list-item-sku {
            font-size: 0.8rem;
            color: #666;
        }
        
        .overview-list-item-status {
            font-size: 0.75rem;
        }
        
        /* 新增：批量操作样式 */
        .batch-operations {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .batch-operations-header {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        
        .batch-operation-item {
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 6px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        
        .batch-operation-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .batch-operation-item-name {
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .batch-operation-item-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .product-image-small {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        /* 新增：历史记录详情展开样式 */
        .history-item-expandable {
            cursor: pointer;
        }
        
        .history-item-details {
            display: none;
            background-color: #f8f9fa;
            padding: 10px;
            margin-top: 8px;
            border-radius: 6px;
            border-left: 3px solid #2575fc;
        }
        
        .history-item-details.show {
            display: block;
        }
        
        .history-detail-item {
            margin-bottom: 6px;
            font-size: 0.85rem;
        }
        
        .history-detail-label {
            font-weight: 600;
            color: #495057;
            display: inline-block;
            width: 70px;
        }
        
        .history-expand-btn {
            background: none;
            border: none;
            color: #2575fc;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 5px;
        }
        
        /* 新增：文本解析出库样式 */
        .text-parse-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .text-parse-textarea {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            resize: vertical;
        }
        
        .text-parse-result {
            background-color: white;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
        }
        
        .parse-result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f1f1;
        }
        
        .parse-result-item:last-child {
            border-bottom: none;
        }
        
        /* 新增：可点击的商品列表项 */
        .clickable-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .clickable-item:hover {
            background-color: rgba(37, 117, 252, 0.05);
        }
        
        /* 新增：返回列表按钮 */
        .back-to-list-btn {
            background-color: #6c757d;
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            margin-bottom: 10px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        /* 新增：历史记录操作按钮 */
        .history-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }
        
        .history-action-btn {
            padding: 4px 8px;
            border-radius: 4px;
            border: none;
            font-size: 0.75rem;
            cursor: pointer;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
        }
        
        .history-action-btn:hover {
            background-color: #e9ecef;
        }
        
        /* 新增：出入库编辑模态框 */
        .edit-stock-operation-modal .modal-content {
            max-width: 600px;
        }
        
        .edit-operation-items {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        /* 新增：商品数据分组样式 */
        .products-group {
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .products-group-header {
            background-color: #f8f9fa;
            padding: 12px 15px;
            font-weight: 600;
            color: #495057;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .products-group-header i {
            transition: transform 0.3s ease;
        }
        
        .products-group-header.collapsed i {
            transform: rotate(-90deg);
        }
        
        .products-group-items {
            background-color: white;
            display: block;
        }
        
        .products-group-items.collapsed {
            display: none;
        }
        
        .products-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f1f1f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .products-item:last-child {
            border-bottom: none;
        }
        
        .products-item-info {
            flex: 1;
        }
        
        .products-item-name {
            font-weight: 500;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
        }
        
        .products-item-sku {
            font-size: 0.8rem;
            color: #666;
        }
        
        .products-item-type {
            font-size: 0.75rem;
            margin-top: 3px;
        }
        
        /* 新增：商品数据表头设置 */
        .products-header-settings {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .products-column-toggle {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .products-column-toggle:last-child {
            margin-bottom: 0;
        }
        
        .products-column-toggle label {
            margin-left: 8px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        
        /* 修复3: 商品数据里的设置按钮居中且不超出屏幕 */
        #toggleHeaderSettings {
            position: absolute;
            right: 50px; /* 调整位置，避免超出屏幕 */
            top: 50%;
            transform: translateY(-50%);
            z-index: 5;
            padding: 6px 10px;
            background-color: #6c757d;
            color: white;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        /* 新增：模态框中的搜索框样式 */
        .modal-search-box {
            margin-bottom: 15px;
        }
        
        .modal-search-input {
            width: 100%;
            padding: 10px 12px 10px 40px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23999' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 12px center;
            background-size: 16px;
        }
        
        /* 新增：单个商品加库存模态框样式 */
        .single-add-inventory-modal .modal-content {
            max-width: 400px;
        }
        
        .single-add-inventory-item {
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .single-add-inventory-item-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .single-add-inventory-item-img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 10px;
        }
        
        .single-add-inventory-item-info {
            flex: 1;
        }
        
        .single-add-inventory-item-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .single-add-inventory-item-sku {
            font-size: 0.9rem;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 8px;
                padding-bottom: 90px;
            }
            
            /* 修复1: 调整手机端页头和导航标签间距 */
            header {
                padding: 12px;
            }
            
            .nav-tabs {
                top: 60px; /* 减少间隙 */
                margin: 10px 0;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .btn-group {
                flex-wrap: wrap;
            }
            
            table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            th, td {
                min-width: 100px;
                font-size: 0.8rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn-sm {
                padding: 8px 10px;
                width: 100%;
                margin-bottom: 4px;
                font-size: 0.8rem;
            }
            
            .filter-row {
                flex-direction: column;
                gap: 8px;
            }
            
            .toggle-content {
                grid-template-columns: repeat(2, 1fr);
            }
            
            /* 修复：保持数据总览2个一行 */
            .overview-stats {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            
            .product-actions-btn {
                width: 100%;
            }
            
            .product-actions-content {
                position: fixed;
                bottom: 0;
                right: 0;
                left: 0;
                width: 100%;
                max-width: 100%;
                border-radius: 10px 10px 0 0;
                margin-top: 0;
                max-height: 50vh;
                overflow-y: auto;
                box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
                z-index: 10000; /* 提高移动端的z-index */
            }
            
            .product-actions-content button {
                padding: 15px;
                font-size: 1rem;
            }
            
            /* 修复：在移动端确保按钮点击后能正常展开 */
            .product-actions-dropdown {
                position: static; /* 改为static，使下拉菜单相对于视口定位 */
            }
            
            .product-actions-content {
                position: fixed !important; /* 使用fixed确保在视口中 */
                top: auto !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                margin: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                transform: none !important;
            }
            
            /* 修复：导航标签在移动端横向滚动 */
            .nav-tabs {
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab {
                flex: 0 0 auto;
                padding: 12px 15px;
            }
            
            /* 修复2: 在手机端选项卡显示简称 */
            .tab[data-tab="overview"] .tab-text::after {
                content: "总览";
            }
            .tab[data-tab="inventory"] .tab-text::after {
                content: "管理";
            }
            .tab[data-tab="history"] .tab-text::after {
                content: "历史";
            }
            .tab[data-tab="products"] .tab-text::after {
                content: "数据";
            }
            .tab[data-tab="settings"] .tab-text::after {
                content: "设置";
            }
            
            .tab .tab-text {
                font-size: 0; /* 隐藏原有文本 */
            }
            
            .tab .tab-text::after {
                font-size: 0.8rem;
                display: inline-block;
            }
            
            /* 修复3: 移动端设置按钮调整 */
            #toggleHeaderSettings {
                right: 45px;
                padding: 5px 8px;
                font-size: 0.75rem;
                width: 34px;
                height: 34px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* 修复2: 移动端悬浮按钮位置调整 */
            .floating-action-btn {
                bottom: 90px; /* 移动端提高位置 */
                right: 10px;
                width: 50px;
                height: 50px;
                font-size: 1.3rem;
                z-index: 1000; /* 确保在最上层 */
            }
            
            /* 模态框样式调整 */
            .modal-content {
                max-width: 95%;
            }
        }
        
        @media (max-width: 480px) {
            .header-content {
                flex-direction: row; /* 保持水平排列 */
                gap: 10px;
                text-align: left; /* 左对齐 */
            }
            
            h1 {
                font-size: 1.1rem;
            }
            
            header {
                padding: 10px;
            }
            
            .nav-tabs {
                flex-wrap: nowrap;
                top: 55px; /* 进一步减小间隙 */
                margin: 8px 0;
            }
            
            .tab {
                flex: 0 0 auto;
                padding: 10px 12px;
                font-size: 0.8rem;
            }
            
            .tab i {
                margin-right: 3px;
                font-size: 0.9rem;
            }
            
            .card {
                padding: 12px;
            }
            
            .modal-content {
                max-height: 80vh;
            }
            
            .toggle-content {
                grid-template-columns: 1fr;
            }
            
            /* 修复2: 超小屏幕悬浮按钮位置调整 */
            .floating-action-btn {
                bottom: 80px;
                right: 8px;
                width: 48px;
                height: 48px;
                font-size: 1.2rem;
                z-index: 1000;
            }
            
            /* 修复：在超小屏幕也保持2个一行 */
            .overview-stats {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            
            /* 修复3: 超小屏幕设置按钮调整 */
            #toggleHeaderSettings {
                right: 40px;
                padding: 4px 6px;
                font-size: 0.7rem;
                width: 32px;
                height: 32px;
            }
            
            /* 修复2: 在超小手机端选项卡显示简称（覆盖上面的设置） */
            .tab[data-tab="overview"] .tab-text::after {
                content: "总览";
            }
            .tab[data-tab="inventory"] .tab-text::after {
                content: "管理";
            }
            .tab[data-tab="history"] .tab-text::after {
                content: "历史";
            }
            .tab[data-tab="products"] .tab-text::after {
                content: "数据";
            }
            .tab[data-tab="settings"] .tab-text::after {
                content: "设置";
            }
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 15px;
            background-color: #333;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            display: none;
            max-width: 280px;
            animation: slideIn 0.3s ease;
            font-size: 0.9rem;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast.show {
            display: block;
        }
        
        .toast-success {
            background-color: #28a745;
        }
        
        .toast-error {
            background-color: #dc3545;
        }
        
        .toast-info {
            background-color: #17a2b8;
        }
        
        .input-with-icon {
            position: relative;
        }
        
        .input-with-icon i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        .input-with-icon input {
            padding-left: 40px;
        }
        
        .system-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .stat-item {
            text-align: center;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2575fc;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #666;
        }
        
        .no-data {
            text-align: center;
            padding: 20px;
            color: #999;
            font-size: 0.9rem;
        }
        
        /* 新增：修复商品搜索框中的设置按钮样式 */
        .search-box {
            position: relative;
        }
        
        #toggleHeaderSettings {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            padding: 6px 10px;
            background-color: #6c757d;
            color: white;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            z-index: 5;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 为tab添加tab-text类用于显示简称 */
        .tab-text {
            display: inline;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1><i class="fas fa-boxes"></i> 商品库存管理系统 V8.260113.01</h1>
            <div class="action-dropdown">
                <button class="action-dropdown-btn" id="actionDropdownBtn">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <div class="action-dropdown-content" id="actionDropdownContent">
                    <a href="#" id="exportAllDataBtn"><i class="fas fa-file-export"></i> 导出数据</a>
                    <a href="#" id="importDataBtn"><i class="fas fa-file-import"></i> 导入数据</a>
                    <a href="#" id="resetSystemBtn"><i class="fas fa-redo"></i> 重置系统</a>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- 操作按钮折叠区域 -->
        <div class="toggle-buttons" id="toggleButtons">
            <div class="toggle-header">
                <div class="toggle-title">请选择操作</div>
                <button class="modal-close" id="closeToggleButtons">&times;</button>
            </div>
            <div class="toggle-content" id="toggleContent">
                <!-- 动态填充操作按钮 -->
            </div>
        </div>
        
        <!-- 导航标签 -->
        <div class="nav-tabs">
            <div class="tab active" data-tab="overview">
                <i class="fas fa-chart-pie"></i> <span class="tab-text">数据总览</span>
            </div>
            <div class="tab" data-tab="inventory">
                <i class="fas fa-boxes"></i> <span class="tab-text">库存管理</span>
            </div>
            <div class="tab" data-tab="history">
                <i class="fas fa-history"></i> <span class="tab-text">操作历史</span>
            </div>
            <div class="tab" data-tab="products">
                <i class="fas fa-database"></i> <span class="tab-text">商品数据</span>
            </div>
            <div class="tab" data-tab="settings">
                <i class="fas fa-cog"></i> <span class="tab-text">系统设置</span>
            </div>
        </div>
        
        <!-- 数据总览标签页 -->
        <div id="overview-tab" class="tab-content active">
            <div class="overview-stats">
                <div class="overview-stat-item" id="overviewTotalProductsItem">
                    <div class="overview-stat-value" id="overviewTotalProducts">0</div>
                    <div class="overview-stat-label">商品总数</div>
                </div>
                <div class="overview-stat-item" id="overviewTotalInventoryItem">
                    <div class="overview-stat-value" id="overviewTotalInventory">0</div>
                    <div class="overview-stat-label">库存商品</div>
                </div>
                <div class="overview-stat-item" id="overviewInStockItem">
                    <div class="overview-stat-value" id="overviewInStock">0</div>
                    <div class="overview-stat-label">有库存商品</div>
                </div>
                <div class="overview-stat-item" id="overviewOutOfStockItem">
                    <div class="overview-stat-value" id="overviewOutOfStock">0</div>
                    <div class="overview-stat-label">缺货商品</div>
                </div>
                <div class="overview-stat-item" id="overviewLowStockItem">
                    <div class="overview-stat-value" id="overviewLowStock">0</div>
                    <div class="overview-stat-label">库存预警</div>
                </div>
                <div class="overview-stat-item" id="overviewTodayOperationsItem">
                    <div class="overview-stat-value" id="overviewTodayOperations">0</div>
                    <div class="overview-stat-label">今日操作</div>
                </div>
            </div>
            
            <!-- 移除了库存状态分布图表区域 -->
            
            <div class="overview-list" id="lowStockListContainer">
                <div class="overview-list-title">
                    <span>库存预警商品 (库存低于预警值)</span>
                    <span class="badge badge-warning" id="lowStockCount">0</span>
                </div>
                <div id="lowStockList">
                    <!-- 库存预警商品列表 -->
                </div>
            </div>
            
            <div class="overview-list" id="outOfStockListContainer">
                <div class="overview-list-title">
                    <span>缺货商品 (库存为0)</span>
                    <span class="badge badge-danger" id="outOfStockCount">0</span>
                </div>
                <div id="outOfStockList">
                    <!-- 缺货商品列表 -->
                </div>
            </div>
        </div>
        
        <!-- 库存管理标签页 -->
        <div id="inventory-tab" class="tab-content">
            <div class="search-box">
                <input type="text" id="inventorySearch" class="search-input" placeholder="搜索库存商品...">
                <button class="clear-search-btn" id="clearInventorySearch" style="display: none;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="inventoryBackToList" style="display: none;">
                <button class="back-to-list-btn" id="backToInventoryList">
                    <i class="fas fa-arrow-left"></i> 返回完整列表
                </button>
            </div>
            
            <div class="text-parse-section" id="textParseSection" style="display: none;">
                <div class="form-group">
                    <label class="form-label">粘贴出库记录文本（支持批量解析）</label>
                    <textarea id="stockOutText" class="text-parse-textarea" placeholder="例如：
统计结果:
--------------------
敲鱼棒 (大号（直径4cm/长40cm）): 1
轴承敲击棒 (小号棒): 2
轴承敲击棒 (大号棒): 2
轴承敲击棒 (轴承拆卸敲击棒): 1
轴承敲击棒 (内筒安装棒 升级版): 4
轴承敲击棒 (双头棒): 1
敲鱼棒 (小号（直径4cm/长30cm）): 2"></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn btn-info" id="parseStockOutTextBtn">
                        <i class="fas fa-search"></i> 解析文本
                    </button>
                    <button class="btn btn-info" id="reparseStockOutTextBtn" style="display: none;">
                        <i class="fas fa-redo"></i> 重新解析
                    </button>
                    <button class="btn btn-primary" id="applyParsedStockOutBtn" style="display: none;">
                        <i class="fas fa-check"></i> 应用解析结果
                    </button>
                    <button class="btn btn-secondary" id="cancelParseBtn">
                        <i class="fas fa-times"></i> 取消
                    </button>
                </div>
                <div id="textParseResult" class="text-parse-result" style="display: none;">
                    <!-- 解析结果显示 -->
                </div>
            </div>
            
            <div id="inventoryGroups">
                <!-- 库存分组将通过JavaScript动态填充 -->
            </div>
            
            <div id="inventoryEmptyState" class="empty-state">
                <i class="fas fa-boxes"></i>
                <p>暂无库存数据，请先添加商品到库存</p>
                <button class="btn btn-primary" style="margin-top: 15px;" id="addProductsToInventory">添加商品到库存</button>
            </div>
            
            <!-- 浮动操作按钮 -->
            <div class="floating-action-btn" id="fabInventory">
                <i class="fas fa-plus"></i>
            </div>
        </div>
        
        <!-- 操作历史标签页 -->
        <div id="history-tab" class="tab-content">
            <div class="filter-section">
                <div class="filter-row">
                    <div class="form-group">
                        <label class="form-label">开始日期</label>
                        <input type="date" id="historyStartDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">结束日期</label>
                        <input type="date" id="historyEndDate" class="form-control">
                    </div>
                </div>
                <div class="filter-row">
                    <div class="form-group">
                        <label class="form-label">操作类型</label>
                        <select id="historyActionType" class="form-control">
                            <option value="">全部类型</option>
                            <option value="stock_in">入库</option>
                            <option value="stock_out">出库</option>
                            <option value="stock_check">盘点</option>
                            <option value="product_add">添加商品</option>
                            <option value="product_edit">编辑商品</option>
                            <option value="product_delete">删除商品</option>
                            <option value="inventory_add">添加到库存</option>
                            <option value="inventory_edit">编辑库存</option>
                            <option value="inventory_delete">移除库存</option>
                            <option value="stock_undo">撤销出入库</option>
                        </select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="btn btn-secondary" id="clearHistoryFilters">清空筛选</button>
                    <button class="btn btn-primary" id="applyHistoryFilters">应用筛选</button>
                </div>
            </div>
            
            <div id="historyList">
                <!-- 历史记录将通过JavaScript动态填充 -->
            </div>
            
            <div id="historyEmptyState" class="empty-state">
                <i class="fas fa-history"></i>
                <p>暂无操作历史记录</p>
            </div>
        </div>
        
        <!-- 商品数据库标签页 -->
        <div id="products-tab" class="tab-content">
            <!-- 商品数据表头设置 -->
            <div class="products-header-settings" id="productsHeaderSettings" style="display: none;">
                <div class="card-header">
                    <div class="card-title">显示列设置</div>
                </div>
                <div class="products-column-toggle">
                    <input type="checkbox" id="toggleImageColumn" checked>
                    <label for="toggleImageColumn">显示图片列</label>
                </div>
                <div class="products-column-toggle">
                    <input type="checkbox" id="toggleTypeColumn" checked>
                    <label for="toggleTypeColumn">显示类型列</label>
                </div>
                <div class="products-column-toggle">
                    <input type="checkbox" id="toggleRemarkColumn" checked>
                    <label for="toggleRemarkColumn">显示备注列</label>
                </div>
                <button class="btn btn-sm btn-secondary" id="applyColumnSettings" style="margin-top: 10px;">
                    <i class="fas fa-check"></i> 应用设置
                </button>
            </div>
            
            <div class="search-box">
                <input type="text" id="productSearch" class="search-input" placeholder="搜索商品名称、SKU或类型...">
                <button class="clear-search-btn" id="clearProductSearch" style="display: none;">
                    <i class="fas fa-times"></i>
                </button>
                <!-- 修复3: 设置按钮位置已调整 -->
                <button class="btn btn-sm btn-secondary" id="toggleHeaderSettings">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
            
            <!-- 商品数据分组显示 -->
            <div id="productsGroups">
                <!-- 商品分组将通过JavaScript动态填充 -->
            </div>
            
            <div id="productsEmptyState" class="empty-state">
                <i class="fas fa-box-open"></i>
                <p>暂无商品数据，请添加商品或导入数据</p>
            </div>
            
            <!-- 浮动操作按钮 -->
            <div class="floating-action-btn" id="fabProducts">
                <i class="fas fa-plus"></i>
            </div>
        </div>
        
        <!-- 系统设置标签页 -->
        <div id="settings-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">系统统计</div>
                </div>
                <div class="system-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalProducts">0</div>
                        <div class="stat-label">商品总数</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalInventory">0</div>
                        <div class="stat-label">库存商品</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalHistory">0</div>
                        <div class="stat-label">操作记录</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">数据管理</div>
                </div>
                
                <div class="export-import-buttons">
                    <input type="file" id="importAllFile" class="file-input" accept=".xlsx,.xls">
                    <label for="importAllFile" class="file-label"><i class="fas fa-file-import"></i> 导入全部数据</label>
                    
                    <button class="btn btn-secondary" id="exportAllBtn"><i class="fas fa-file-export"></i> 导出全部数据</button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">历史记录设置</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">历史记录保留</label>
                    <p>系统会自动清理超过30天的历史记录，最多保留1000条记录。</p>
                    <p style="color: #dc3545; font-size: 0.9rem;">
                        <i class="fas fa-info-circle"></i> 注意：自动清理后无法恢复，重要操作请定期导出备份。
                    </p>
                </div>
                
                <div class="form-group">
                    <button class="btn btn-info" id="manualCleanupBtn">
                        <i class="fas fa-broom"></i> 立即清理历史记录
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">系统重置</div>
                </div>
                
                <div class="warning-box">
                    <h4><i class="fas fa-exclamation-triangle"></i> 警告</h4>
                    <p>重置系统将清除所有商品数据、库存数据和操作历史记录，此操作不可恢复，请谨慎操作！</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">重置系统密码</label>
                    <input type="password" id="resetPassword" class="form-control" placeholder="请输入重置密码（默认：123456）">
                </div>
                
                <button class="btn btn-danger" id="resetSystemConfirmBtn"><i class="fas fa-redo"></i> 重置系统</button>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">关于系统</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">系统版本</label>
                    <p>自研库存管理系统 v2.3 作者：kevin鲁大师</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">存储说明</label>
                    <p>数据存储在浏览器本地，清除浏览器缓存将丢失数据，请定期导出备份。</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加/编辑商品模态框 -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="productModalTitle">添加商品</div>
                <button class="modal-close" id="closeProductModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <div class="form-group">
                        <label class="form-label">商品名称 *</label>
                        <input type="text" id="productName" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">SKU *</label>
                        <input type="text" id="productSKU" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">类型 *</label>
                        <select id="productType" class="form-control">
                            <option value="product">单品</option>
                            <option value="set">套装</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="setContentGroup" style="display: none;">
                        <label class="form-label">套装内容</label>
                        <textarea id="productSetContent" class="form-control" rows="2" placeholder="请输入套装内容，用分号;分隔"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">图片URL</label>
                        <input type="text" id="productImage" class="form-control" placeholder="请输入图片网络地址">
                    </div>
                    
                    <!-- 新增：库存预警值输入框 -->
                    <div class="form-group">
                        <label class="form-label">库存预警值</label>
                        <input type="number" id="productWarningValue" class="form-control" min="1" value="5">
                        <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                            <i class="fas fa-info-circle"></i> 当库存低于此值时系统会预警
                        </div>
                    </div>
                    
                    <div class="img-preview-container">
                        <img id="productImagePreview" class="img-preview" src="" alt="图片预览" style="display: none;">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">备注</label>
                        <textarea id="productRemark" class="form-control" rows="2" placeholder="请输入商品备注信息"></textarea>
                    </div>
                    
                    <input type="hidden" id="productId">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelProductModal">取消</button>
                <button class="btn btn-primary" id="saveProductBtn">保存商品</button>
            </div>
        </div>
    </div>
    
    <!-- 库存盘点模态框 -->
    <div id="stockCheckModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">库存盘点</div>
                <button class="modal-close" id="closeStockCheckModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-search-box">
                    <input type="text" id="stockCheckSearch" class="modal-search-input" placeholder="搜索商品名称或SKU...">
                </div>
                
                <div class="batch-operations">
                    <div class="batch-operations-header">选择盘点商品（可多选）</div>
                    <div id="stockCheckItems">
                        <!-- 盘点商品项动态添加 -->
                    </div>
                    <button class="btn btn-sm btn-info" id="selectAllStockCheck" style="margin-top: 10px;">
                        <i class="fas fa-check-square"></i> 全选
                    </button>
                </div>
                
                <div id="stockCheckResult" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">盘点结果</label>
                        <div id="stockCheckMessage"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelStockCheckModal">取消</button>
                <button class="btn btn-primary" id="executeStockCheckBtn">执行盘点</button>
            </div>
        </div>
    </div>
    
    <!-- 添加到库存模态框 -->
    <div id="addToInventoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">添加到库存</div>
                <button class="modal-close" id="closeAddToInventoryModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-search-box">
                    <input type="text" id="addInventorySearch" class="modal-search-input" placeholder="搜索商品名称或SKU...">
                </div>
                
                <div class="batch-operations">
                    <div class="batch-operations-header">选择商品（可多选）</div>
                    <div id="addInventoryItems">
                        <!-- 添加库存商品项动态添加 -->
                    </div>
                    <button class="btn btn-sm btn-info" id="selectAllAddInventory" style="margin-top: 10px;">
                        <i class="fas fa-check-square"></i> 全选
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelAddToInventoryModal">取消</button>
                <button class="btn btn-primary" id="saveToInventoryBtn">添加到库存</button>
            </div>
        </div>
    </div>
    
    <!-- 单个商品加库存模态框 -->
    <div id="singleAddToInventoryModal" class="modal single-add-inventory-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">添加商品到库存</div>
                <button class="modal-close" id="closeSingleAddToInventoryModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="singleAddInventoryItem">
                    <!-- 单个商品信息动态添加 -->
                </div>
                
                <div class="form-group">
                    <label class="form-label">初始库存</label>
                    <input type="number" id="singleInitialStock" class="form-control" value="0" min="0">
                </div>
                
                <div class="form-group">
                    <label class="form-label">预警值</label>
                    <input type="number" id="singleWarningValue" class="form-control" value="5" min="1" placeholder="当库存低于此值时预警">
                </div>
                
                <div class="form-group">
                    <label class="form-label">备注</label>
                    <textarea id="singleAddInventoryRemark" class="form-control" rows="2" placeholder="请输入添加到库存的备注信息"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelSingleAddToInventoryModal">取消</button>
                <button class="btn btn-primary" id="saveSingleToInventoryBtn">添加到库存</button>
            </div>
        </div>
    </div>
    
    <!-- 批量添加到库存模态框 -->
    <div id="batchAddToInventoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">批量添加到库存</div>
                <button class="modal-close" id="closeBatchAddToInventoryModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">选择商品（可多选）</label>
                    <select id="batchAddInventoryProductSelect" class="form-control" multiple size="6">
                        <option value="">请选择商品</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">预警库存值（适用于所有选中商品）</label>
                    <input type="number" id="batchInventoryWarningValue" class="form-control" min="1" value="5" placeholder="当库存低于此值时预警">
                </div>
                
                <div class="form-group">
                    <label class="form-label">备注</label>
                    <textarea id="batchAddInventoryRemark" class="form-control" rows="2" placeholder="请输入批量添加到库存的备注信息"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelBatchAddToInventoryModal">取消</button>
                <button class="btn btn-primary" id="saveBatchToInventoryBtn">添加到库存</button>
            </div>
        </div>
    </div>
    
    <!-- 出入库操作模态框 -->
    <div id="stockOperationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="stockOperationTitle">出入库操作</div>
                <button class="modal-close" id="closeStockOperationModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-search-box">
                    <input type="text" id="stockOperationSearch" class="modal-search-input" placeholder="搜索商品名称或SKU...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">操作类型 *</label>
                    <select id="stockOperationType" class="form-control">
                        <option value="in">入库</option>
                        <option value="out">出库</option>
                    </select>
                </div>
                
                <div class="batch-operations">
                    <div class="batch-operations-header">选择商品（可多选）</div>
                    <div id="stockOperationItems">
                        <!-- 动态添加商品数量输入 -->
                    </div>
                    <button class="btn btn-sm btn-info" id="selectAllStockOperation" style="margin-top: 10px;">
                        <i class="fas fa-check-square"></i> 全选
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">备注</label>
                    <textarea id="stockOperationRemark" class="form-control" rows="2" placeholder="请输入出入库备注信息（可选）"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelStockOperationModal">取消</button>
                <button class="btn btn-primary" id="executeStockOperationBtn">执行操作</button>
            </div>
        </div>
    </div>
    
    <!-- 编辑出入库操作模态框 -->
    <div id="editStockOperationModal" class="modal edit-stock-operation-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">编辑出入库操作</div>
                <button class="modal-close" id="closeEditStockOperationModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">操作备注</label>
                    <textarea id="editStockOperationRemark" class="form-control" rows="2" placeholder="请输入出入库备注信息"></textarea>
                </div>
                
                <div class="batch-operations">
                    <div class="batch-operations-header">商品明细</div>
                    <div class="edit-operation-items" id="editStockOperationItems">
                        <!-- 动态添加商品编辑项 -->
                    </div>
                </div>
                
                <div class="warning-box" style="margin-top: 15px;">
                    <h4><i class="fas fa-info-circle"></i> 说明</h4>
                    <p>修改数量将直接更新库存，系统会自动记录修改前后的差异。</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEditStockOperationModal">取消</button>
                <button class="btn btn-primary" id="saveEditStockOperationBtn">保存修改</button>
            </div>
        </div>
    </div>
    
    <!-- 图片全屏查看模态框 -->
    <div id="fullscreenImageModal" class="fullscreen-img">
        <span class="close-fullscreen">&times;</span>
        <img id="fullscreenImage" src="" alt="全屏图片">
    </div>
    
    <!-- 提示消息 -->
    <div id="toast" class="toast"></div>
    
    <div class="footer-info">
        <p>自研商品库存管理系统 &copy; 2026 | 作者：kevin鲁大师 | 数据存储在本地浏览器 请常导出数据备份</p>
    </div>

    <script>
        // 全局变量
        let products = [];
        let inventory = [];
        let history = [];
        let editingProductId = null;
        let editingInventoryId = null;
        let currentTab = 'overview';
        let inventoryChart = null;
        let parsedStockOutData = null; // 存储解析的出库数据
        let editingHistoryItem = null; // 存储正在编辑的历史记录
        let columnSettings = {
            showImage: true,
            showType: true,
            showRemark: true
        };
        let singleAddProductId = null; // 单个商品加库存的商品ID
        
        // 程序专属数据标识
        const DATA_PREFIX = 'inventory_system_v2_';
        
        // 初始化函数
        function init() {
            loadDataFromStorage();
            
            // 清理旧的历史记录
            cleanupOldHistory();
            
            setupEventListeners();
            renderInventoryGroups();
            renderProductsGroups(); // 改为渲染分组商品数据
            renderHistory();
            updateSystemStats();
            populateProductSelects();
            updateOverview();
            
            // 默认显示数据总览标签页
            switchTab('overview');
            
            // 加载示例数据（第一次使用时）
            if (products.length === 0 && inventory.length === 0 && history.length === 0) {
                loadSampleData();
            }
            
            // 在移动端调整选项卡文本
            adjustTabTextForMobile();
        }
        
        // 调整移动端选项卡文本
        function adjustTabTextForMobile() {
            if (window.innerWidth <= 768) {
                // 移动端已经通过CSS显示简称，这里只需确保JavaScript操作正常
                console.log('移动端显示选项卡简称');
            }
        }
        
        // 从本地存储加载数据 - 修复：使用特定前缀避免读取其他程序数据
        function loadDataFromStorage() {
            // 使用特定前缀，避免与其他程序冲突
            const productsData = localStorage.getItem(DATA_PREFIX + 'products');
            const inventoryData = localStorage.getItem(DATA_PREFIX + 'inventory');
            const historyData = localStorage.getItem(DATA_PREFIX + 'history');
            const settingsData = localStorage.getItem(DATA_PREFIX + 'settings');
            
            // 检查并迁移旧版本数据（一次性）
            migrateOldDataIfNeeded();
            
            if (productsData) {
                try {
                    products = JSON.parse(productsData);
                } catch (e) {
                    console.error('解析商品数据失败:', e);
                    products = [];
                }
            }
            
            if (inventoryData) {
                try {
                    inventory = JSON.parse(inventoryData);
                } catch (e) {
                    console.error('解析库存数据失败:', e);
                    inventory = [];
                }
            }
            
            if (historyData) {
                try {
                    history = JSON.parse(historyData);
                } catch (e) {
                    console.error('解析历史数据失败:', e);
                    history = [];
                }
            }
            
            if (settingsData) {
                try {
                    const settings = JSON.parse(settingsData);
                    if (settings.columnSettings) {
                        columnSettings = settings.columnSettings;
                    }
                } catch (e) {
                    console.error('解析设置数据失败:', e);
                }
            }
        }
        
        // 迁移旧版本数据
        function migrateOldDataIfNeeded() {
            // 检查是否有旧版本数据
            const oldKeys = [
                'inventory_system_products',
                'inventory_system_inventory',
                'inventory_system_history',
                'inventory_system_settings',
                'products',
                'inventory',
                'history'
            ];
            
            oldKeys.forEach(oldKey => {
                const oldData = localStorage.getItem(oldKey);
                if (oldData) {
                    // 根据旧键名确定数据类型
                    let newKey = '';
                    if (oldKey.includes('products') || oldKey === 'products') {
                        newKey = DATA_PREFIX + 'products';
                    } else if (oldKey.includes('inventory') || oldKey === 'inventory') {
                        newKey = DATA_PREFIX + 'inventory';
                    } else if (oldKey.includes('history') || oldKey === 'history') {
                        newKey = DATA_PREFIX + 'history';
                    } else if (oldKey.includes('settings')) {
                        newKey = DATA_PREFIX + 'settings';
                    }
                    
                    if (newKey) {
                        // 迁移数据
                        localStorage.setItem(newKey, oldData);
                        console.log(`数据已从 ${oldKey} 迁移到 ${newKey}`);
                        
                        // 删除旧数据（可选，建议保留一段时间）
                        // localStorage.removeItem(oldKey);
                    }
                }
            });
        }
        
        // 保存数据到本地存储 - 修复：使用特定前缀
        function saveDataToStorage() {
            localStorage.setItem(DATA_PREFIX + 'products', JSON.stringify(products));
            localStorage.setItem(DATA_PREFIX + 'inventory', JSON.stringify(inventory));
            localStorage.setItem(DATA_PREFIX + 'history', JSON.stringify(history));
            
            // 保存设置
            const settings = {
                columnSettings: columnSettings,
                version: '2.3',
                lastUpdated: new Date().toISOString()
            };
            localStorage.setItem(DATA_PREFIX + 'settings', JSON.stringify(settings));
        }
        
        // 安全清除本程序数据（不影响其他程序）
        function clearProgramDataOnly() {
            // 只删除本程序的数据键
            const programKeys = [
                DATA_PREFIX + 'products',
                DATA_PREFIX + 'inventory',
                DATA_PREFIX + 'history',
                DATA_PREFIX + 'settings'
            ];
            
            programKeys.forEach(key => {
                localStorage.removeItem(key);
            });
            
            // 可选：清理可能的旧版本数据
            const oldKeys = [
                'inventory_system_products',
                'inventory_system_inventory',
                'inventory_system_history',
                'inventory_system_settings'
            ];
            
            oldKeys.forEach(key => {
                localStorage.removeItem(key);
            });
            
            console.log('已安全清除本程序数据，不影响其他程序');
        }
        
        // 加载示例数据
        function loadSampleData() {
            // 示例商品数据
            const sampleProducts = [
                {
                    id: generateId(),
                    name: "轴承敲击棒",
                    sku: "小号棒",
                    type: "product",
                    imageUrl: "https://img.alicdn.com/imgextra/i4/2200647343461/O1CN01RrCDUb1bRBq3xYthu_!!2200647343461.jpg",
                    setContent: "",
                    stock: 0,
                    stockHistory: [],
                    remark: "示例商品数据",
                    createdAt: new Date().toISOString()
                },
                {
                    id: generateId(),
                    name: "轴承敲击棒",
                    sku: "大号棒",
                    type: "product",
                    imageUrl: "https://img.alicdn.com/imgextra/i3/2200647343461/O1CN0146jr2z1bRBpz6pvjZ_!!2200647343461.jpg",
                    setContent: "",
                    stock: 0,
                    stockHistory: [],
                    remark: "示例商品数据",
                    createdAt: new Date().toISOString()
                },
                {
                    id: generateId(),
                    name: "敲鱼棒",
                    sku: "大号（直径4cm/长40cm）",
                    type: "product",
                    imageUrl: "",
                    setContent: "",
                    stock: 0,
                    stockHistory: [],
                    remark: "示例商品数据",
                    createdAt: new Date().toISOString()
                },
                {
                    id: generateId(),
                    name: "轴承敲击棒",
                    sku: "内筒安装棒 升级版",
                    type: "product",
                    imageUrl: "",
                    setContent: "",
                    stock: 0,
                    stockHistory: [],
                    remark: "示例商品数据",
                    createdAt: new Date().toISOString()
                },
                {
                    id: generateId(),
                    name: "敲鱼棒",
                    sku: "小号（直径4cm/长30cm）",
                    type: "product",
                    imageUrl: "",
                    setContent: "",
                    stock: 0,
                    stockHistory: [],
                    remark: "示例商品数据",
                    createdAt: new Date().toISOString()
                }
            ];
            
            products = sampleProducts;
            
            // 示例库存数据
            const sampleInventory = [
                {
                    id: generateId(),
                    productId: sampleProducts[0].id,
                    productName: sampleProducts[0].name,
                    productSku: sampleProducts[0].sku,
                    productImage: sampleProducts[0].imageUrl,
                    currentStock: 8,
                    warningValue: 3,
                    remark: "示例库存数据",
                    createdAt: new Date().toISOString()
                },
                {
                    id: generateId(),
                    productId: sampleProducts[1].id,
                    productName: sampleProducts[1].name,
                    productSku: sampleProducts[1].sku,
                    productImage: sampleProducts[1].imageUrl,
                    currentStock: 6,
                    warningValue: 2,
                    remark: "示例库存数据",
                    createdAt: new Date().toISOString()
                },
                {
                    id: generateId(),
                    productId: sampleProducts[2].id,
                    productName: sampleProducts[2].name,
                    productSku: sampleProducts[2].sku,
                    productImage: sampleProducts[2].imageUrl,
                    currentStock: 5,
                    warningValue: 3,
                    remark: "示例库存数据",
                    createdAt: new Date().toISOString()
                },
                {
                    id: generateId(),
                    productId: sampleProducts[3].id,
                    productName: sampleProducts[3].name,
                    productSku: sampleProducts[3].sku,
                    productImage: sampleProducts[3].imageUrl,
                    currentStock: 10,
                    warningValue: 5,
                    remark: "示例库存数据",
                    createdAt: new Date().toISOString()
                },
                {
                    id: generateId(),
                    productId: sampleProducts[4].id,
                    productName: sampleProducts[4].name,
                    productSku: sampleProducts[4].sku,
                    productImage: sampleProducts[4].imageUrl,
                    currentStock: 3,
                    warningValue: 5,
                    remark: "示例库存数据",
                    createdAt: new Date().toISOString()
                }
            ];
            
            inventory = sampleInventory;
            
            // 示例历史记录（添加 operationItems）
            const sampleHistory = [
                {
                    id: generateId(),
                    action: "product_add",
                    target: "轴承敲击棒 (小号棒)",
                    details: "添加了新商品: 轴承敲击棒 (小号棒)",
                    timestamp: new Date(Date.now() - 86400000).toISOString(),
                    user: "系统",
                    remark: "示例历史记录",
                    operationItems: []
                },
                {
                    id: generateId(),
                    action: "stock_out",
                    target: "批量出库操作",
                    details: "出库操作: 敲鱼棒 (大号（直径4cm/长40cm）)，数量: 1，库存从 5 变为 4; 轴承敲击棒 (小号棒)，数量: 2，库存从 8 变为 6; 轴承敲击棒 (大号棒)，数量: 2，库存从 6 变为 4; 轴承敲击棒 (内筒安装棒 升级版)，数量: 4，库存从 10 变为 6; 敲鱼棒 (小号（直径4cm/长30cm）)，数量: 2，库存从 3 变为 1;",
                    timestamp: new Date(Date.now() - 43200000).toISOString(),
                    user: "管理员",
                    remark: "批量出库操作",
                    operationItems: [
                        {
                            productId: sampleProducts[2].id,
                            productName: "敲鱼棒",
                            sku: "大号（直径4cm/长40cm）",
                            oldStock: 5,
                            newStock: 4,
                            quantity: 1
                        },
                        {
                            productId: sampleProducts[0].id,
                            productName: "轴承敲击棒",
                            sku: "小号棒",
                            oldStock: 8,
                            newStock: 6,
                            quantity: 2
                        },
                        {
                            productId: sampleProducts[1].id,
                            productName: "轴承敲击棒",
                            sku: "大号棒",
                            oldStock: 6,
                            newStock: 4,
                            quantity: 2
                        },
                        {
                            productId: sampleProducts[3].id,
                            productName: "轴承敲击棒",
                            sku: "内筒安装棒 升级版",
                            oldStock: 10,
                            newStock: 6,
                            quantity: 4
                        },
                        {
                            productId: sampleProducts[4].id,
                            productName: "敲鱼棒",
                            sku: "小号（直径4cm/长30cm）",
                            oldStock: 3,
                            newStock: 1,
                            quantity: 2
                        }
                    ]
                }
            ];
            
            history = sampleHistory;
            
            saveDataToStorage();
            updateOverview();
            showToast("已加载示例数据", "success");
        }
        
        // 生成唯一ID
        function generateId() {
            return Date.now().toString() + Math.random().toString(36).substr(2, 9);
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 标签页切换
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // 操作下拉菜单
            document.getElementById('actionDropdownBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('actionDropdownContent').classList.toggle('show');
            });
            
            // 点击其他地方关闭下拉菜单
            document.addEventListener('click', () => {
                document.getElementById('actionDropdownContent').classList.remove('show');
            });
            
            // 浮动操作按钮
            document.getElementById('fabInventory').addEventListener('click', () => {
                showToggleButtons('inventory');
            });
            
            document.getElementById('fabProducts').addEventListener('click', () => {
                showToggleButtons('products');
            });
            
            document.getElementById('closeToggleButtons').addEventListener('click', () => {
                document.getElementById('toggleButtons').classList.remove('active');
            });
            
            // 添加商品到库存按钮
            document.getElementById('addProductsToInventory').addEventListener('click', () => {
                openAddToInventoryModal();
            });
            
            // 商品管理
            document.getElementById('saveProductBtn').addEventListener('click', () => saveProduct());
            document.getElementById('cancelProductModal').addEventListener('click', () => closeProductModal());
            document.getElementById('closeProductModal').addEventListener('click', () => closeProductModal());
            
            // 商品类型变化时显示/隐藏套装内容字段
            document.getElementById('productType').addEventListener('change', function() {
                document.getElementById('setContentGroup').style.display = this.value === 'set' ? 'block' : 'none';
            });
            
            // 图片URL输入时预览
            document.getElementById('productImage').addEventListener('input', function() {
                const preview = document.getElementById('productImagePreview');
                if (this.value && isValidURL(this.value)) {
                    preview.src = this.value;
                    preview.style.display = 'block';
                } else {
                    preview.style.display = 'none';
                }
            });
            
            // 库存管理
            document.getElementById('executeStockCheckBtn').addEventListener('click', () => executeStockCheck());
            document.getElementById('cancelStockCheckModal').addEventListener('click', () => closeStockCheckModal());
            document.getElementById('closeStockCheckModal').addEventListener('click', () => closeStockCheckModal());
            
            // 添加到库存
            document.getElementById('saveToInventoryBtn').addEventListener('click', () => addToInventory());
            document.getElementById('cancelAddToInventoryModal').addEventListener('click', () => closeAddToInventoryModal());
            document.getElementById('closeAddToInventoryModal').addEventListener('click', () => closeAddToInventoryModal());
            
            // 单个商品加库存
            document.getElementById('saveSingleToInventoryBtn').addEventListener('click', () => saveSingleToInventory());
            document.getElementById('cancelSingleAddToInventoryModal').addEventListener('click', () => closeSingleAddToInventoryModal());
            document.getElementById('closeSingleAddToInventoryModal').addEventListener('click', () => closeSingleAddToInventoryModal());
            
            // 批量添加到库存
            document.getElementById('saveBatchToInventoryBtn').addEventListener('click', () => batchAddToInventory());
            document.getElementById('cancelBatchAddToInventoryModal').addEventListener('click', () => closeBatchAddToInventoryModal());
            document.getElementById('closeBatchAddToInventoryModal').addEventListener('click', () => closeBatchAddToInventoryModal());
            
            // 出入库操作
            document.getElementById('executeStockOperationBtn').addEventListener('click', () => executeStockOperation());
            document.getElementById('cancelStockOperationModal').addEventListener('click', () => closeStockOperationModal());
            document.getElementById('closeStockOperationModal').addEventListener('click', () => closeStockOperationModal());
            
            // 出入库操作类型变化
            document.getElementById('stockOperationType').addEventListener('change', function() {
                const title = this.value === 'in' ? '入库操作' : '出库操作';
                document.getElementById('stockOperationTitle').textContent = title;
                populateStockOperationItems();
            });
            
            // 编辑出入库操作
            document.getElementById('saveEditStockOperationBtn').addEventListener('click', () => saveEditStockOperation());
            document.getElementById('cancelEditStockOperationModal').addEventListener('click', () => closeEditStockOperationModal());
            document.getElementById('closeEditStockOperationModal').addEventListener('click', () => closeEditStockOperationModal());
            
            // 历史记录
            document.getElementById('applyHistoryFilters').addEventListener('click', () => applyHistoryFilters());
            document.getElementById('clearHistoryFilters').addEventListener('click', () => clearHistoryFilters());
            
            // 系统设置
            document.getElementById('exportAllBtn').addEventListener('click', () => exportAllData());
            document.getElementById('exportAllDataBtn').addEventListener('click', () => exportAllData());
            document.getElementById('importDataBtn').addEventListener('click', () => document.getElementById('importAllFile').click());
            document.getElementById('importAllFile').addEventListener('change', (e) => importAllData(e));
            document.getElementById('resetSystemConfirmBtn').addEventListener('click', () => resetSystem());
            
            // 手动清理历史记录
            document.getElementById('manualCleanupBtn')?.addEventListener('click', () => {
                if (confirm('确定要立即清理超过30天的历史记录吗？此操作不可恢复。')) {
                    const oldCount = history.length;
                    cleanupOldHistory();
                    const newCount = history.length;
                    const cleanedCount = oldCount - newCount;
                    
                    renderHistory();
                    updateSystemStats();
                    
                    showToast(`已清理 ${cleanedCount} 条超过30天的历史记录`, 'success');
                }
            });
            
            // 搜索功能
            document.getElementById('productSearch').addEventListener('input', () => {
                renderProductsGroups();
                const searchTerm = document.getElementById('productSearch').value.trim();
                document.getElementById('clearProductSearch').style.display = searchTerm ? 'block' : 'none';
            });
            
            document.getElementById('inventorySearch').addEventListener('input', () => {
                renderInventoryGroups();
                const searchTerm = document.getElementById('inventorySearch').value.trim();
                document.getElementById('clearInventorySearch').style.display = searchTerm ? 'block' : 'none';
            });
            
            // 模态框搜索功能
            document.getElementById('stockCheckSearch')?.addEventListener('input', () => {
                populateStockCheckItems();
            });
            
            document.getElementById('addInventorySearch')?.addEventListener('input', () => {
                populateAddInventoryItems();
            });
            
            document.getElementById('stockOperationSearch')?.addEventListener('input', () => {
                populateStockOperationItems();
            });
            
            // 清空搜索
            document.getElementById('clearProductSearch').addEventListener('click', () => {
                document.getElementById('productSearch').value = '';
                document.getElementById('clearProductSearch').style.display = 'none';
                renderProductsGroups();
            });
            
            document.getElementById('clearInventorySearch').addEventListener('click', () => {
                document.getElementById('inventorySearch').value = '';
                document.getElementById('clearInventorySearch').style.display = 'none';
                document.getElementById('inventoryBackToList').style.display = 'none';
                renderInventoryGroups();
            });
            
            // 返回列表按钮
            document.getElementById('backToInventoryList').addEventListener('click', () => {
                document.getElementById('inventorySearch').value = '';
                document.getElementById('clearInventorySearch').style.display = 'none';
                document.getElementById('inventoryBackToList').style.display = 'none';
                renderInventoryGroups();
            });
            
            // 图片全屏查看
            document.querySelector('.close-fullscreen').addEventListener('click', () => {
                document.getElementById('fullscreenImageModal').classList.remove('active');
            });
            
            // 全选按钮
            document.getElementById('selectAllStockCheck')?.addEventListener('click', () => toggleAllCheckboxes('stockCheck'));
            document.getElementById('selectAllAddInventory')?.addEventListener('click', () => toggleAllCheckboxes('addInventory'));
            document.getElementById('selectAllStockOperation')?.addEventListener('click', () => toggleAllCheckboxes('stockOperation'));
            
            // 文本解析出库功能
            document.getElementById('parseStockOutTextBtn')?.addEventListener('click', () => parseStockOutText());
            document.getElementById('reparseStockOutTextBtn')?.addEventListener('click', () => reparseStockOutText());
            document.getElementById('applyParsedStockOutBtn')?.addEventListener('click', () => applyParsedStockOut());
            document.getElementById('cancelParseBtn')?.addEventListener('click', () => cancelParse());
            
            // 数据总览点击事件
            document.getElementById('overviewTotalProductsItem')?.addEventListener('click', () => {
                switchTab('products');
                showToast("已切换到商品数据页面", "info");
            });
            
            document.getElementById('overviewTotalInventoryItem')?.addEventListener('click', () => {
                switchTab('inventory');
                showToast("已切换到库存管理页面", "info");
            });
            
            document.getElementById('overviewInStockItem')?.addEventListener('click', () => {
                switchTab('inventory');
                document.getElementById('inventorySearch').value = '';
                // 搜索有库存的商品
                const searchEvent = new Event('input', { bubbles: true });
                document.getElementById('inventorySearch').dispatchEvent(searchEvent);
                showToast("显示有库存的商品", "info");
            });
            
            document.getElementById('overviewOutOfStockItem')?.addEventListener('click', () => {
                switchTab('inventory');
                document.getElementById('inventorySearch').value = '缺货';
                const searchEvent = new Event('input', { bubbles: true });
                document.getElementById('inventorySearch').dispatchEvent(searchEvent);
                showToast("显示缺货商品", "info");
            });
            
            document.getElementById('overviewLowStockItem')?.addEventListener('click', () => {
                switchTab('inventory');
                document.getElementById('inventorySearch').value = '预警';
                const searchEvent = new Event('input', { bubbles: true });
                document.getElementById('inventorySearch').dispatchEvent(searchEvent);
                showToast("显示库存预警商品", "info");
            });
            
            document.getElementById('overviewTodayOperationsItem')?.addEventListener('click', () => {
                switchTab('history');
                // 设置筛选为今天
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('historyStartDate').value = today;
                document.getElementById('historyEndDate').value = today;
                applyHistoryFilters();
                showToast("显示今日操作记录", "info");
            });
            
            // 库存预警和缺货列表点击事件
            document.getElementById('lowStockListContainer')?.addEventListener('click', (e) => {
                if (e.target.closest('.overview-list-item')) {
                    switchTab('inventory');
                    document.getElementById('inventorySearch').value = '预警';
                    const searchEvent = new Event('input', { bubbles: true });
                    document.getElementById('inventorySearch').dispatchEvent(searchEvent);
                    showToast("显示库存预警商品", "info");
                }
            });
            
            document.getElementById('outOfStockListContainer')?.addEventListener('click', (e) => {
                if (e.target.closest('.overview-list-item')) {
                    switchTab('inventory');
                    document.getElementById('inventorySearch').value = '缺货';
                    const searchEvent = new Event('input', { bubbles: true });
                    document.getElementById('inventorySearch').dispatchEvent(searchEvent);
                    showToast("显示缺货商品", "info");
                }
            });
            
            // 商品数据表头设置
            document.getElementById('toggleHeaderSettings').addEventListener('click', () => {
                const settings = document.getElementById('productsHeaderSettings');
                settings.style.display = settings.style.display === 'none' ? 'block' : 'none';
            });
            
            document.getElementById('applyColumnSettings').addEventListener('click', () => {
                columnSettings.showImage = document.getElementById('toggleImageColumn').checked;
                columnSettings.showType = document.getElementById('toggleTypeColumn').checked;
                columnSettings.showRemark = document.getElementById('toggleRemarkColumn').checked;
                saveDataToStorage();
                renderProductsGroups();
                document.getElementById('productsHeaderSettings').style.display = 'none';
                showToast("列设置已应用", "success");
            });
            
            // 点击模态框外部关闭
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        if (modal.id === 'productModal') closeProductModal();
                        if (modal.id === 'stockCheckModal') closeStockCheckModal();
                        if (modal.id === 'addToInventoryModal') closeAddToInventoryModal();
                        if (modal.id === 'singleAddToInventoryModal') closeSingleAddToInventoryModal();
                        if (modal.id === 'batchAddToInventoryModal') closeBatchAddToInventoryModal();
                        if (modal.id === 'stockOperationModal') closeStockOperationModal();
                        if (modal.id === 'editStockOperationModal') closeEditStockOperationModal();
                    }
                });
            });
            
            // 窗口大小变化时调整选项卡文本
            window.addEventListener('resize', adjustTabTextForMobile);
        }
        
        // 切换标签页
        function switchTab(tabId) {
            currentTab = tabId;
            
            // 更新标签页样式
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            
            // 更新内容区域
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabId}-tab`).classList.add('active');
            
            // 更新浮动按钮显示
            document.getElementById('fabInventory').style.display = tabId === 'inventory' ? 'flex' : 'none';
            document.getElementById('fabProducts').style.display = tabId === 'products' ? 'flex' : 'none';
            
            // 关闭操作按钮折叠区域
            document.getElementById('toggleButtons').classList.remove('active');
            
            // 隐藏文本解析区域（如果显示的话）
            document.getElementById('textParseSection').style.display = 'none';
            parsedStockOutData = null;
            
            // 隐藏商品数据表头设置
            document.getElementById('productsHeaderSettings').style.display = 'none';
            
            // 更新页面标题
            const tabNames = {
                'overview': '数据总览',
                'inventory': '库存管理',
                'history': '操作历史',
                'products': '商品数据库',
                'settings': '系统设置'
            };
            document.querySelector('h1').innerHTML = `<i class="fas fa-boxes"></i> ${tabNames[tabId]}`;
            
            // 如果是总览页面，更新图表
            if (tabId === 'overview') {
                updateOverview();
            }
            
            // 如果是库存管理页面，确保文本解析区域初始隐藏
            if (tabId === 'inventory') {
                document.getElementById('textParseSection').style.display = 'none';
            }
            
            // 如果是历史页面，确保实时更新
            if (tabId === 'history') {
                renderHistory();
            }
            
            // 如果是商品数据页面，更新设置复选框状态
            if (tabId === 'products') {
                document.getElementById('toggleImageColumn').checked = columnSettings.showImage;
                document.getElementById('toggleTypeColumn').checked = columnSettings.showType;
                document.getElementById('toggleRemarkColumn').checked = columnSettings.showRemark;
            }
        }
        
        // 显示操作按钮折叠区域
        function showToggleButtons(tab) {
            const toggleContent = document.getElementById('toggleContent');
            let buttonsHTML = '';
            
            if (tab === 'inventory') {
                buttonsHTML = `
                    <div class="toggle-btn" onclick="openStockCheckModal()">
                        <i class="fas fa-clipboard-check"></i>
                        <div>库存盘点</div>
                    </div>
                    <div class="toggle-btn" onclick="openStockOperationModal('in')">
                        <i class="fas fa-arrow-up"></i>
                        <div>入库操作</div>
                    </div>
                    <div class="toggle-btn" onclick="openStockOperationModal('out')">
                        <i class="fas fa-arrow-down"></i>
                        <div>出库操作</div>
                    </div>
                    <div class="toggle-btn" onclick="openAddToInventoryModal()">
                        <i class="fas fa-box"></i>
                        <div>添加商品到库存</div>
                    </div>
                    <div class="toggle-btn" onclick="showTextParseSection()">
                        <i class="fas fa-file-alt"></i>
                        <div>解析出库文本</div>
                    </div>
                `;
            } else if (tab === 'products') {
                buttonsHTML = `
                    <div class="toggle-btn" onclick="openProductModal()">
                        <i class="fas fa-plus"></i>
                        <div>添加商品</div>
                    </div>
                    <div class="toggle-btn" onclick="importProducts()">
                        <i class="fas fa-file-import"></i>
                        <div>导入商品</div>
                    </div>
                    <div class="toggle-btn" onclick="exportProducts()">
                        <i class="fas fa-file-export"></i>
                        <div>导出商品</div>
                    </div>
                `;
            }
            
            toggleContent.innerHTML = buttonsHTML;
            document.getElementById('toggleButtons').classList.add('active');
        }
        
        // 显示文本解析区域
        function showTextParseSection() {
            document.getElementById('toggleButtons').classList.remove('active');
            document.getElementById('textParseSection').style.display = 'block';
            document.getElementById('textParseResult').style.display = 'none';
            document.getElementById('applyParsedStockOutBtn').style.display = 'none';
            document.getElementById('reparseStockOutTextBtn').style.display = 'none';
            document.getElementById('parseStockOutTextBtn').style.display = 'inline-block';
            document.getElementById('stockOutText').value = '';
            parsedStockOutData = null;
        }
        
        // 解析出库文本（修复版，能正确识别完整SKU）
        function parseStockOutText() {
            const text = document.getElementById('stockOutText').value.trim();
            if (!text) {
                showToast('请输入出库记录文本', 'error');
                return;
            }
            
            // 只解析"统计结果:"之后的数据
            const lines = text.split('\n');
            let startParsing = false;
            const items = [];
            
            // 新的正则表达式：匹配 "商品名称 (SKU): 数量" 格式
            // 例如：敲鱼棒 (大号（直径4cm/长40cm）): 1
            const itemPattern = /^(.+?)\s*\((.+?)\):\s*(\d+)$/;
            
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                
                // 找到"统计结果:"开始解析
                if (line.includes('统计结果')) {
                    startParsing = true;
                    return;
                }
                
                // 跳过分隔线
                if (line.includes('===') || line.includes('---')) {
                    return;
                }
                
                // 开始解析数据
                if (startParsing) {
                    // 使用新的正则表达式匹配
                    const match = line.match(itemPattern);
                    if (match) {
                        const productName = match[1].trim(); // 商品名称
                        const sku = match[2].trim();        // SKU（括号内的完整内容）
                        const quantity = parseInt(match[3]);
                        
                        console.log(`解析到商品: ${productName}, SKU: ${sku}, 数量: ${quantity}`);
                        items.push({ productName, sku, quantity });
                    } else {
                        // 如果没有括号，使用原来的简单匹配
                        const simpleMatch = line.match(/(.+?):\s*(\d+)/);
                        if (simpleMatch) {
                            const productName = simpleMatch[1].trim();
                            const quantity = parseInt(simpleMatch[2]);
                            items.push({ productName, sku: productName, quantity });
                        }
                    }
                }
            });
            
            if (items.length === 0) {
                showToast('未能解析出任何商品信息，请检查文本格式', 'error');
                return;
            }
            
            // 在库存中查找匹配的商品
            const matchedItems = [];
            const unmatchedItems = [];
            
            console.log('解析到的商品列表:', items);
            console.log('当前库存列表:', inventory);
            
            items.forEach(item => {
                // 尝试匹配商品
                let matched = false;
                
                // 首先尝试精确匹配SKU（包含空格和特殊字符）
                for (const invItem of inventory) {
                    if (invItem.productSku === item.sku) {
                        console.log(`精确匹配到: ${invItem.productSku} = ${item.sku}`);
                        matchedItems.push({
                            ...item,
                            inventoryItem: invItem,
                            matchedSku: invItem.productSku,
                            matchedName: invItem.productName
                        });
                        matched = true;
                        break;
                    }
                }
                
                // 如果精确匹配失败，尝试部分匹配SKU
                if (!matched) {
                    for (const invItem of inventory) {
                        // 检查库存SKU是否包含解析到的SKU，或者解析到的SKU是否包含库存SKU
                        if (item.sku.includes(invItem.productSku) || 
                            invItem.productSku.includes(item.sku)) {
                            console.log(`部分匹配到: ${invItem.productSku} ~ ${item.sku}`);
                            matchedItems.push({
                                ...item,
                                inventoryItem: invItem,
                                matchedSku: invItem.productSku,
                                matchedName: invItem.productName
                            });
                            matched = true;
                            break;
                        }
                    }
                }
                
                // 如果SKU不匹配，尝试匹配商品名称
                if (!matched) {
                    for (const invItem of inventory) {
                        if (item.productName.includes(invItem.productName) ||
                            invItem.productName.includes(item.productName)) {
                            console.log(`通过商品名称匹配到: ${invItem.productName}`);
                            matchedItems.push({
                                ...item,
                                inventoryItem: invItem,
                                matchedSku: invItem.productSku,
                                matchedName: invItem.productName
                            });
                            matched = true;
                            break;
                        }
                    }
                }
                
                if (!matched) {
                    console.log(`未匹配到: ${item.productName} (${item.sku})`);
                    unmatchedItems.push(item);
                }
            });
            
            // 显示解析结果
            const resultContainer = document.getElementById('textParseResult');
            let html = '';
            
            if (matchedItems.length > 0) {
                html += '<div style="margin-bottom: 10px;"><strong>匹配到的商品：</strong></div>';
                matchedItems.forEach(item => {
                    const stockClass = getStockClass(item.inventoryItem.currentStock, item.inventoryItem.warningValue);
                    const stockStatus = getStockStatus(item.inventoryItem.currentStock, item.inventoryItem.warningValue);
                    
                    html += `
                        <div class="parse-result-item">
                            <div>
                                <div><strong>${item.matchedName}</strong></div>
                                <div style="font-size: 0.8rem; color: #666;">${item.matchedSku}</div>
                                <div style="font-size: 0.8rem;">当前库存: ${item.inventoryItem.currentStock}，出库: ${item.quantity}</div>
                            </div>
                            <div>
                                <span class="badge ${stockClass === 'stock-normal' ? 'badge-success' : stockClass === 'stock-low' ? 'badge-warning' : 'badge-danger'}">
                                    ${stockStatus}
                                </span>
                            </div>
                        </div>
                    `;
                });
            }
            
            if (unmatchedItems.length > 0) {
                html += '<div style="margin-top: 15px; margin-bottom: 10px;"><strong>未匹配到的商品：</strong></div>';
                unmatchedItems.forEach(item => {
                    html += `
                        <div class="parse-result-item" style="color: #dc3545;">
                            <div>${item.productName} (${item.sku})</div>
                            <div>${item.quantity} 件</div>
                        </div>
                    `;
                });
            }
            
            resultContainer.innerHTML = html;
            resultContainer.style.display = 'block';
            
            if (matchedItems.length > 0) {
                // 显示应用按钮和重新解析按钮，隐藏解析文本按钮
                document.getElementById('applyParsedStockOutBtn').style.display = 'inline-block';
                document.getElementById('reparseStockOutTextBtn').style.display = 'inline-block';
                document.getElementById('parseStockOutTextBtn').style.display = 'none';
                parsedStockOutData = matchedItems;
                showToast(`解析完成！匹配到 ${matchedItems.length} 个商品，${unmatchedItems.length} 个未匹配`, 'success');
            } else {
                document.getElementById('applyParsedStockOutBtn').style.display = 'none';
                document.getElementById('reparseStockOutTextBtn').style.display = 'inline-block';
                document.getElementById('parseStockOutTextBtn').style.display = 'none';
                parsedStockOutData = null;
                showToast('未能匹配到任何库存商品', 'error');
            }
        }
        
        // 重新解析文本
        function reparseStockOutText() {
            // 清空解析结果
            document.getElementById('textParseResult').style.display = 'none';
            document.getElementById('textParseResult').innerHTML = '';
            // 隐藏应用解析结果按钮和重新解析按钮，显示解析文本按钮
            document.getElementById('applyParsedStockOutBtn').style.display = 'none';
            document.getElementById('reparseStockOutTextBtn').style.display = 'none';
            document.getElementById('parseStockOutTextBtn').style.display = 'inline-block';
            // 清空存储的解析数据
            parsedStockOutData = null;
            // 清空文本框
            document.getElementById('stockOutText').value = '';
        }
        
        // 应用解析的出库数据（增加成功/失败反馈）
        function applyParsedStockOut() {
            if (!parsedStockOutData || parsedStockOutData.length === 0) {
                showToast('没有可应用的解析数据', 'error');
                return;
            }
            
            // 检查库存是否足够
            let hasInsufficientStock = false;
            const insufficientItems = [];
            
            parsedStockOutData.forEach(item => {
                if (item.quantity > item.inventoryItem.currentStock) {
                    hasInsufficientStock = true;
                    insufficientItems.push({
                        name: item.matchedName,
                        sku: item.matchedSku,
                        current: item.inventoryItem.currentStock,
                        required: item.quantity
                    });
                }
            });
            
            if (hasInsufficientStock) {
                let errorMsg = '以下商品库存不足：<br>';
                insufficientItems.forEach(item => {
                    errorMsg += `${item.name} (${item.sku})：当前 ${item.current}，需要 ${item.required}<br>`;
                });
                showToast(errorMsg, 'error');
                return;
            }
            
            // 执行出库操作
            let operationDetails = '';
            const operationItems = [];
            let successCount = 0;
            let failedCount = 0;
            
            parsedStockOutData.forEach(item => {
                try {
                    const oldStock = item.inventoryItem.currentStock;
                    item.inventoryItem.currentStock -= item.quantity;
                    operationDetails += `${item.matchedName} (${item.matchedSku})，数量: ${item.quantity}，库存从 ${oldStock} 变为 ${item.inventoryItem.currentStock}; `;
                    operationItems.push({
                        productId: item.inventoryItem.productId,
                        productName: item.matchedName,
                        sku: item.matchedSku,
                        oldStock: oldStock,
                        newStock: item.inventoryItem.currentStock,
                        quantity: item.quantity
                    });
                    successCount++;
                } catch (error) {
                    console.error(`出库操作失败: ${item.matchedName}`, error);
                    failedCount++;
                }
            });
            
            // 添加历史记录（包含操作详情供撤销使用）
            addHistory(
                'stock_out', 
                `批量出库（文本解析）`, 
                `批量出库操作: ${operationDetails}`,
                '通过文本解析一键出库',
                operationItems
            );
            
            saveDataToStorage();
            renderInventoryGroups();
            updateSystemStats();
            updateOverview();
            
            // 重置解析区域
            document.getElementById('textParseSection').style.display = 'none';
            document.getElementById('textParseResult').style.display = 'none';
            document.getElementById('applyParsedStockOutBtn').style.display = 'none';
            document.getElementById('reparseStockOutTextBtn').style.display = 'none';
            document.getElementById('parseStockOutTextBtn').style.display = 'inline-block';
            document.getElementById('stockOutText').value = '';
            parsedStockOutData = null;
            
            // 显示成功/失败统计
            let resultMessage = `出库操作完成，成功: ${successCount} 个商品`;
            if (failedCount > 0) {
                resultMessage += `，失败: ${failedCount} 个商品`;
            }
            showToast(resultMessage, failedCount > 0 ? 'warning' : 'success');
        }
        
        // 取消解析
        function cancelParse() {
            document.getElementById('textParseSection').style.display = 'none';
            document.getElementById('textParseResult').style.display = 'none';
            document.getElementById('applyParsedStockOutBtn').style.display = 'none';
            document.getElementById('reparseStockOutTextBtn').style.display = 'none';
            document.getElementById('parseStockOutTextBtn').style.display = 'inline-block';
            document.getElementById('stockOutText').value = '';
            parsedStockOutData = null;
        }
        
        // 渲染库存分组（默认折叠）
        function renderInventoryGroups() {
            const inventoryGroupsContainer = document.getElementById('inventoryGroups');
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
            const emptyState = document.getElementById('inventoryEmptyState');
            
            if (inventory.length === 0) {
                inventoryGroupsContainer.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            // 按商品名称分组
            const groupedInventory = {};
            inventory.forEach(item => {
                if (searchTerm) {
                    // 特殊搜索词处理
                    if (searchTerm === '缺货') {
                        if (item.currentStock > 0) return;
                    } else if (searchTerm === '预警') {
                        if (item.currentStock === 0 || item.currentStock >= item.warningValue) return;
                    } else if (searchTerm === '有库存') {
                        if (item.currentStock === 0) return;
                    } else {
                        // 普通搜索
                        if (!item.productName.toLowerCase().includes(searchTerm) && 
                            !item.productSku.toLowerCase().includes(searchTerm)) {
                            return;
                        }
                    }
                }
                
                if (!groupedInventory[item.productName]) {
                    groupedInventory[item.productName] = [];
                }
                groupedInventory[item.productName].push(item);
            });
            
            let html = '';
            const productNames = Object.keys(groupedInventory);
            
            if (productNames.length === 0) {
                html = '<div class="no-data">没有找到匹配的库存商品</div>';
            } else {
                productNames.forEach(productName => {
                    const items = groupedInventory[productName];
                    const groupId = `group-${productName.replace(/\s+/g, '-')}`;
                    
                    html += `
                        <div class="inventory-group">
                            <div class="inventory-group-header collapsed" data-group="${groupId}">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-chevron-right"></i>
                                    <span>${productName}</span>
                                    <span class="badge badge-info">${items.length} 个型号</span>
                                </div>
                                <div style="display: flex; align-items: center;">
                                    <span class="badge ${getGroupStockClass(items)}" style="margin-right: 10px;">
                                        ${getGroupStockStatus(items)}
                                    </span>
                                </div>
                            </div>
                            <div class="inventory-group-items collapsed" id="${groupId}">
                    `;
                    
                    items.forEach(item => {
                        const stockClass = getStockClass(item.currentStock, item.warningValue);
                        const stockStatus = getStockStatus(item.currentStock, item.warningValue);
                        
                        html += `
                            <div class="inventory-item clickable-item" onclick="focusInventoryItem('${item.productSku}')">
                                <div class="inventory-item-info">
                                    <div class="inventory-item-name">
                                        ${item.productImage ? 
                                            `<img src="${item.productImage}" alt="${item.productName}" class="product-image-small" onclick="viewImageFullscreen('${item.productImage}'); event.stopPropagation();">` : 
                                            ''
                                        }
                                        ${item.productSku}
                                    </div>
                                    <div class="inventory-item-sku">${item.remark || '无备注'}</div>
                                </div>
                                <div class="inventory-item-stock">
                                    <div class="inventory-item-quantity">${item.currentStock}</div>
                                    <div class="inventory-item-status">
                                        <span class="badge ${stockClass === 'stock-normal' ? 'badge-success' : stockClass === 'stock-low' ? 'badge-warning' : 'badge-danger'}">
                                            ${stockStatus}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
            }
            
            inventoryGroupsContainer.innerHTML = html;
            
            // 添加折叠/展开事件监听器
            document.querySelectorAll('.inventory-group-header').forEach(header => {
                header.addEventListener('click', function() {
                    const groupId = this.getAttribute('data-group');
                    const groupItems = document.getElementById(groupId);
                    
                    if (groupItems.classList.contains('collapsed')) {
                        groupItems.classList.remove('collapsed');
                        this.classList.remove('collapsed');
                        this.querySelector('i').className = 'fas fa-chevron-down';
                    } else {
                        groupItems.classList.add('collapsed');
                        this.classList.add('collapsed');
                        this.querySelector('i').className = 'fas fa-chevron-right';
                    }
                });
            });
            
            // 如果搜索框有内容，显示返回列表按钮
            if (searchTerm) {
                document.getElementById('inventoryBackToList').style.display = 'block';
            } else {
                document.getElementById('inventoryBackToList').style.display = 'none';
            }
        }
        
        // 渲染商品数据分组（修复：改为分组显示）
        function renderProductsGroups() {
            const productsGroupsContainer = document.getElementById('productsGroups');
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const emptyState = document.getElementById('productsEmptyState');
            
            if (products.length === 0) {
                productsGroupsContainer.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            // 按商品名称分组
            const groupedProducts = {};
            products.forEach(product => {
                if (searchTerm) {
                    // 普通搜索
                    if (!product.name.toLowerCase().includes(searchTerm) && 
                        !product.sku.toLowerCase().includes(searchTerm) &&
                        !product.type.toLowerCase().includes(searchTerm)) {
                        return;
                    }
                }
                
                if (!groupedProducts[product.name]) {
                    groupedProducts[product.name] = [];
                }
                groupedProducts[product.name].push(product);
            });
            
            let html = '';
            const productNames = Object.keys(groupedProducts);
            
            if (productNames.length === 0) {
                html = '<div class="no-data">没有找到匹配的商品</div>';
            } else {
                productNames.forEach(productName => {
                    const items = groupedProducts[productName];
                    const groupId = `products-group-${productName.replace(/\s+/g, '-')}`;
                    
                    html += `
                        <div class="products-group">
                            <div class="products-group-header collapsed" data-group="${groupId}">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-chevron-right"></i>
                                    <span>${productName}</span>
                                    <span class="badge badge-info">${items.length} 个型号</span>
                                </div>
                            </div>
                            <div class="products-group-items collapsed" id="${groupId}">
                    `;
                    
                    items.forEach(item => {
                        // 检查是否在库存中
                        const inInventory = inventory.some(invItem => invItem.productId === item.id);
                        
                        html += `
                            <div class="products-item">
                                <div class="products-item-info">
                                    <div class="products-item-name">
                                        ${columnSettings.showImage && item.imageUrl ? 
                                            `<img src="${item.imageUrl}" alt="${item.name}" class="product-image-small" onclick="viewImageFullscreen('${item.imageUrl}'); event.stopPropagation();">` : 
                                            ''
                                        }
                                        ${item.sku}
                                        ${inInventory ? `<span class="badge badge-success" style="margin-left: 8px;">在库存中</span>` : ''}
                                    </div>
                                    ${columnSettings.showType ? `<div class="products-item-type">
                                        <span class="badge ${item.type === 'set' ? 'badge-info' : 'badge-secondary'}">
                                            ${item.type === 'set' ? '套装' : '单品'}
                                        </span>
                                    </div>` : ''}
                                    ${columnSettings.showRemark && item.remark ? `<div class="products-item-sku">${item.remark}</div>` : ''}
                                </div>
                                <div class="product-actions-dropdown">
                                    <button class="product-actions-btn" onclick="toggleProductActions('${item.id}')">
                                        <i class="fas fa-ellipsis-h"></i> 操作
                                    </button>
                                    <div class="product-actions-content" id="productActions-${item.id}">
                                        <button onclick="editProduct('${item.id}')">
                                            <i class="fas fa-edit"></i> 编辑
                                        </button>
                                        ${!inInventory ? 
                                            `<button onclick="openSingleAddToInventoryModal('${item.id}')">
                                                <i class="fas fa-box"></i> 加库存
                                            </button>` : 
                                            `<button disabled>
                                                <i class="fas fa-check"></i> 在库存中
                                            </button>`
                                        }
                                        <button onclick="deleteProduct('${item.id}')" style="color: #dc3545;">
                                            <i class="fas fa-trash"></i> 删除
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
            }
            
            productsGroupsContainer.innerHTML = html;
            
            // 添加折叠/展开事件监听器
            document.querySelectorAll('.products-group-header').forEach(header => {
                header.addEventListener('click', function() {
                    const groupId = this.getAttribute('data-group');
                    const groupItems = document.getElementById(groupId);
                    
                    if (groupItems.classList.contains('collapsed')) {
                        groupItems.classList.remove('collapsed');
                        this.classList.remove('collapsed');
                        this.querySelector('i').className = 'fas fa-chevron-down';
                    } else {
                        groupItems.classList.add('collapsed');
                        this.classList.add('collapsed');
                        this.querySelector('i').className = 'fas fa-chevron-right';
                    }
                });
            });
        }
        
        // 聚焦到特定库存项
        function focusInventoryItem(sku) {
            // 设置搜索框
            const searchInput = document.getElementById('inventorySearch');
            searchInput.value = sku;
            
            // 触发搜索
            const event = new Event('input', { bubbles: true });
            searchInput.dispatchEvent(event);
            
            // 展开所有分组以便查看
            document.querySelectorAll('.inventory-group-header.collapsed').forEach(header => {
                header.click();
            });
            
            // 显示返回列表按钮
            document.getElementById('inventoryBackToList').style.display = 'block';
            
            showToast(`已聚焦到商品: ${sku}`, 'info');
        }
        
        // 获取分组库存状态
        function getGroupStockStatus(items) {
            let total = items.length;
            let outOfStock = 0;
            let lowStock = 0;
            let normal = 0;
            
            items.forEach(item => {
                if (item.currentStock === 0) {
                    outOfStock++;
                } else if (item.currentStock < item.warningValue) {
                    lowStock++;
                } else {
                    normal++;
                }
            });
            
            if (outOfStock === total) return '全部缺货';
            if (outOfStock > 0 && lowStock === 0) return `${outOfStock}个缺货`;
            if (lowStock > 0) return `${lowStock}个预警`;
            return '库存正常';
        }
        
        // 获取分组库存状态类名
        function getGroupStockClass(items) {
            let total = items.length;
            let outOfStock = 0;
            let lowStock = 0;
            
            items.forEach(item => {
                if (item.currentStock === 0) {
                    outOfStock++;
                } else if (item.currentStock < item.warningValue) {
                    lowStock++;
                }
            });
            
            if (outOfStock === total) return 'badge-danger';
            if (outOfStock > 0) return 'badge-danger';
            if (lowStock > 0) return 'badge-warning';
            return 'badge-success';
        }
        
        // 切换产品操作下拉菜单（修复移动端显示问题）
        function toggleProductActions(productId) {
            const dropdown = document.getElementById(`productActions-${productId}`);
            const isShowing = dropdown.classList.contains('show');
            
            // 先关闭所有其他下拉菜单
            document.querySelectorAll('.product-actions-content.show').forEach(item => {
                if (item !== dropdown) {
                    item.classList.remove('show');
                }
            });
            
            // 切换当前下拉菜单
            dropdown.classList.toggle('show');
            
            // 如果是移动端，使用固定定位
            if (window.innerWidth <= 768) {
                // 移动端：固定在底部
                dropdown.style.position = 'fixed';
                dropdown.style.bottom = '0';
                dropdown.style.top = 'auto';
                dropdown.style.left = '0';
                dropdown.style.right = '0';
                dropdown.style.width = '100%';
                dropdown.style.maxWidth = '100%';
                dropdown.style.margin = '0';
                dropdown.style.borderRadius = '10px 10px 0 0';
                dropdown.style.zIndex = '10000';
            } else {
                // 桌面端：计算位置
                const button = document.querySelector(`button[onclick="toggleProductActions('${productId}')"]`);
                if (button) {
                    const rect = button.getBoundingClientRect();
                    const dropdownHeight = 120; // 预估下拉菜单高度
                    const spaceBelow = window.innerHeight - rect.bottom;
                    const spaceAbove = rect.top;
                    
                    // 如果下方空间不足且上方空间足够，则向上弹出
                    if (spaceBelow < dropdownHeight && spaceAbove > dropdownHeight) {
                        dropdown.style.bottom = '100%';
                        dropdown.style.top = 'auto';
                        dropdown.style.marginTop = '0';
                        dropdown.style.marginBottom = '5px';
                    } else {
                        // 默认向下弹出
                        dropdown.style.bottom = 'auto';
                        dropdown.style.top = '100%';
                        dropdown.style.marginTop = '5px';
                        dropdown.style.marginBottom = '0';
                    }
                }
            }
            
            // 点击其他地方关闭下拉菜单
            if (!isShowing) {
                const closeHandler = function(e) {
                    if (!dropdown.contains(e.target) && !e.target.closest(`.product-actions-btn`)) {
                        dropdown.classList.remove('show');
                        document.removeEventListener('click', closeHandler);
                    }
                };
                
                setTimeout(() => {
                    document.addEventListener('click', closeHandler);
                }, 0);
            }
        }
        
        // 打开单个商品加库存模态框
        function openSingleAddToInventoryModal(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            // 检查是否已在库存中
            if (inventory.some(item => item.productId === productId)) {
                showToast('该商品已在库存管理中', 'error');
                return;
            }
            
            singleAddProductId = productId;
            const modal = document.getElementById('singleAddToInventoryModal');
            const itemContainer = document.getElementById('singleAddInventoryItem');
            
            let html = `
                <div class="single-add-inventory-item">
                    <div class="single-add-inventory-item-header">
                        ${product.imageUrl ? 
                            `<img src="${product.imageUrl}" alt="${product.name}" class="single-add-inventory-item-img">` : 
                            '<div style="width: 50px; height: 50px; background-color: #f8f9fa; border-radius: 5px; display: flex; align-items: center; justify-content: center; margin-right: 10px;"><i class="fas fa-box" style="color: #999;"></i></div>'
                        }
                        <div class="single-add-inventory-item-info">
                            <div class="single-add-inventory-item-name">${product.name}</div>
                            <div class="single-add-inventory-item-sku">${product.sku}</div>
                        </div>
                    </div>
                    ${product.remark ? `<div style="margin-top: 8px; font-size: 0.9rem; color: #666;">备注: ${product.remark}</div>` : ''}
                </div>
            `;
            
            itemContainer.innerHTML = html;
            
            // 重置表单
            document.getElementById('singleInitialStock').value = 0;
            document.getElementById('singleWarningValue').value = 5;
            document.getElementById('singleAddInventoryRemark').value = '';
            
            modal.classList.add('active');
        }
        
        // 关闭单个商品加库存模态框
        function closeSingleAddToInventoryModal() {
            document.getElementById('singleAddToInventoryModal').classList.remove('active');
            document.getElementById('singleAddInventoryItem').innerHTML = '';
            singleAddProductId = null;
        }
        
        // 保存单个商品到库存
        function saveSingleToInventory() {
            if (!singleAddProductId) {
                showToast('未找到商品信息', 'error');
                return;
            }
            
            const product = products.find(p => p.id === singleAddProductId);
            if (!product) {
                showToast('商品不存在', 'error');
                return;
            }
            
            const initialStock = parseInt(document.getElementById('singleInitialStock').value) || 0;
            const warningValue = parseInt(document.getElementById('singleWarningValue').value) || 5;
            const remark = document.getElementById('singleAddInventoryRemark').value.trim();
            
            if (warningValue < 1) {
                showToast('预警值必须大于0', 'error');
                return;
            }
            
            // 创建库存项
            const inventoryItem = {
                id: generateId(),
                productId: product.id,
                productName: product.name,
                productSku: product.sku,
                productImage: product.imageUrl,
                currentStock: initialStock,
                warningValue: warningValue,
                remark: remark || '从商品数据页面添加',
                createdAt: new Date().toISOString()
            };
            
            inventory.push(inventoryItem);
            
            // 添加历史记录
            addHistory('inventory_add', product.name, `添加商品到库存: ${product.name} (${product.sku})，初始库存: ${initialStock}，预警值: ${warningValue}`, remark, [{
                productId: product.id,
                productName: product.name,
                sku: product.sku,
                oldStock: 0,
                newStock: initialStock,
                quantity: initialStock
            }]);
            
            saveDataToStorage();
            renderProductsGroups();
            renderInventoryGroups();
            populateProductSelects();
            updateSystemStats();
            updateOverview();
            closeSingleAddToInventoryModal();
            
            showToast(`成功添加 ${product.name} (${product.sku}) 到库存`, 'success');
        }
        
        // 渲染历史记录（支持展开详情和撤销操作）
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            const emptyState = document.getElementById('historyEmptyState');
            
            // 应用筛选
            let filteredHistory = [...history].reverse(); // 最新的在前面
            
            // 时间筛选
            const startDate = document.getElementById('historyStartDate').value;
            const endDate = document.getElementById('historyEndDate').value;
            const actionType = document.getElementById('historyActionType').value;
            
            if (startDate) {
                const start = new Date(startDate);
                filteredHistory = filteredHistory.filter(item => new Date(item.timestamp) >= start);
            }
            
            if (endDate) {
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999); // 设置为当天结束时间
                filteredHistory = filteredHistory.filter(item => new Date(item.timestamp) <= end);
            }
            
            if (actionType) {
                filteredHistory = filteredHistory.filter(item => item.action === actionType);
            }
            
            if (filteredHistory.length === 0) {
                historyList.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            let html = '';
            filteredHistory.forEach(item => {
                const actionIcons = {
                    'product_add': 'fas fa-plus-circle text-success',
                    'product_edit': 'fas fa-edit text-primary',
                    'product_delete': 'fas fa-trash text-danger',
                    'inventory_add': 'fas fa-boxes text-success',
                    'inventory_edit': 'fas fa-edit text-primary',
                    'inventory_delete': 'fas fa-trash-alt text-danger',
                    'stock_in': 'fas fa-arrow-up text-success',
                    'stock_out': 'fas fa-arrow-down text-warning',
                    'stock_check': 'fas fa-clipboard-check text-info',
                    'system_reset': 'fas fa-redo text-danger',
                    'import': 'fas fa-file-import text-primary',
                    'export': 'fas fa-file-export text-secondary',
                    'stock_undo': 'fas fa-undo text-warning',
                    'system_cleanup': 'fas fa-broom text-secondary'
                };
                
                const actionTexts = {
                    'product_add': '添加商品',
                    'product_edit': '编辑商品',
                    'product_delete': '删除商品',
                    'inventory_add': '添加到库存',
                    'inventory_edit': '编辑库存',
                    'inventory_delete': '从库存移除',
                    'stock_in': '入库操作',
                    'stock_out': '出库操作',
                    'stock_check': '库存盘点',
                    'system_reset': '系统重置',
                    'import': '数据导入',
                    'export': '数据导出',
                    'stock_undo': '撤销出入库',
                    'system_cleanup': '历史记录清理'
                };
                
                const iconClass = actionIcons[item.action] || 'fas fa-history';
                const actionText = actionTexts[item.action] || item.action;
                const time = new Date(item.timestamp).toLocaleString('zh-CN');
                
                html += `
                    <div class="history-item history-item-expandable" data-history-id="${item.id}">
                        <div class="history-action">
                            <i class="${iconClass}"></i> ${actionText}: ${item.target}
                            <button class="history-expand-btn" onclick="toggleHistoryDetails('${item.id}', event)">[展开详情]</button>
                        </div>
                        <div class="history-details">${item.details}</div>
                        <div class="history-time">
                            <i class="far fa-clock"></i> ${time} | 操作人: ${item.user || '系统'}
                        </div>
                        <div class="history-item-details" id="history-details-${item.id}">
                            <div class="history-detail-item">
                                <span class="history-detail-label">操作类型:</span> ${actionText}
                            </div>
                            <div class="history-detail-item">
                                <span class="history-detail-label">操作目标:</span> ${item.target}
                            </div>
                            <div class="history-detail-item">
                                <span class="history-detail-label">操作详情:</span> ${item.details}
                            </div>
                            ${item.remark ? `<div class="history-detail-item">
                                <span class="history-detail-label">备注:</span> ${item.remark}
                            </div>` : ''}
                            <div class="history-detail-item">
                                <span class="history-detail-label">操作人:</span> ${item.user || '系统'}
                            </div>
                            <div class="history-detail-item">
                                <span class="history-detail-label">操作时间:</span> ${time}
                            </div>
                        </div>
                        <div class="history-actions">
                            ${(item.action === 'stock_in' || item.action === 'stock_out') ? `
                                <button class="history-action-btn" onclick="undoStockOperation('${item.id}')">
                                    <i class="fas fa-undo"></i> 撤销
                                </button>
                                <button class="history-action-btn" onclick="editStockOperation('${item.id}')">
                                    <i class="fas fa-edit"></i> 修改
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            historyList.innerHTML = html;
        }
        
        // 切换历史记录详情显示
        function toggleHistoryDetails(historyId, event) {
            event.stopPropagation();
            const detailsElement = document.getElementById(`history-details-${historyId}`);
            const button = event.target;
            
            if (detailsElement.classList.contains('show')) {
                detailsElement.classList.remove('show');
                button.textContent = '[展开详情]';
            } else {
                detailsElement.classList.add('show');
                button.textContent = '[收起详情]';
            }
        }
        
        // 新增：从 details 字符串解析操作项的函数
        function parseOperationItemsFromDetails(details) {
            const operationItems = [];
            
            // 尝试从 details 中解析，格式例如："入库操作: 轴承敲击棒 (小号棒)，数量: 5，库存从 10 变为 15; "
            const operations = details.split(';').filter(op => op.trim());
            
            operations.forEach(op => {
                // 匹配商品名称、SKU和数量
                // 例如：轴承敲击棒 (小号棒)，数量: 5，库存从 10 变为 15
                const pattern = /([^(]+?)\s*\((.+?)\)[^,]*?数量:\s*(\d+)[^,]*?库存从\s*(\d+)\s*变为\s*(\d+)/;
                const match = op.match(pattern);
                
                if (match) {
                    const productName = match[1].trim();
                    const sku = match[2].trim();
                    const quantity = parseInt(match[3]);
                    const oldStock = parseInt(match[4]);
                    const newStock = parseInt(match[5]);
                    
                    // 尝试找到对应的商品ID
                    const inventoryItem = inventory.find(item => 
                        item.productName === productName && item.productSku === sku
                    );
                    
                    if (inventoryItem) {
                        operationItems.push({
                            productId: inventoryItem.productId,
                            productName: productName,
                            sku: sku,
                            oldStock: oldStock,
                            newStock: newStock,
                            quantity: quantity
                        });
                    }
                }
            });
            
            return operationItems;
        }
        
        // 撤销出入库操作
        function undoStockOperation(historyId) {
            const historyItem = history.find(h => h.id === historyId);
            if (!historyItem) {
                showToast('未找到该历史记录', 'error');
                return;
            }
            
            if (!confirm('确定要撤销这次出入库操作吗？这将恢复库存到操作前的状态。')) {
                return;
            }
            
            // 获取操作详情
            let operationItems = historyItem.operationItems || [];
            
            // 如果没有 operationItems，尝试从 details 中解析
            if (operationItems.length === 0 && historyItem.details) {
                operationItems = parseOperationItemsFromDetails(historyItem.details);
            }
            
            if (operationItems.length === 0) {
                showToast('无法撤销此操作，缺少操作详情', 'error');
                return;
            }
            
            // 恢复库存
            let undoDetails = '';
            operationItems.forEach(item => {
                const inventoryItem = inventory.find(i => i.productId === item.productId);
                if (inventoryItem) {
                    // 根据操作类型撤销
                    if (historyItem.action === 'stock_in') {
                        // 撤销入库：减去入库数量
                        inventoryItem.currentStock -= item.quantity;
                        undoDetails += `${item.productName} (${item.sku})，撤销入库 ${item.quantity}，库存从 ${item.newStock} 变为 ${inventoryItem.currentStock}; `;
                    } else if (historyItem.action === 'stock_out') {
                        // 撤销出库：加回出库数量
                        inventoryItem.currentStock += item.quantity;
                        undoDetails += `${item.productName} (${item.sku})，撤销出库 ${item.quantity}，库存从 ${item.newStock} 变为 ${inventoryItem.currentStock}; `;
                    }
                }
            });
            
            // 添加撤销历史记录
            addHistory(
                'stock_undo',
                `撤销${historyItem.action === 'stock_in' ? '入库' : '出库'}操作`,
                `撤销了${historyItem.action === 'stock_in' ? '入库' : '出库'}操作: ${undoDetails}`,
                `撤销原因: 用户手动撤销`
            );
            
            saveDataToStorage();
            renderInventoryGroups();
            updateSystemStats();
            updateOverview();
            
            // 立即更新历史记录显示
            if (currentTab === 'history') {
                renderHistory();
            }
            
            showToast('操作已撤销，库存已恢复', 'success');
        }
        
        // 编辑出入库操作
        function editStockOperation(historyId) {
            const historyItem = history.find(h => h.id === historyId);
            if (!historyItem) {
                showToast('未找到该历史记录', 'error');
                return;
            }
            
            // 检查是否有操作详情，如果没有，尝试从 details 中解析
            let operationItems = historyItem.operationItems || [];
            
            // 如果没有 operationItems，尝试从 details 中解析
            if (operationItems.length === 0 && historyItem.details) {
                console.log('尝试从 details 解析操作详情:', historyItem.details);
                operationItems = parseOperationItemsFromDetails(historyItem.details);
            }
            
            if (operationItems.length === 0) {
                showToast('无法编辑此历史记录，缺少操作详情', 'error');
                return;
            }
            
            editingHistoryItem = historyItem;
            
            const modal = document.getElementById('editStockOperationModal');
            const itemsContainer = document.getElementById('editStockOperationItems');
            const remarkInput = document.getElementById('editStockOperationRemark');
            
            // 设置备注
            remarkInput.value = historyItem.remark || '';
            
            // 渲染编辑项
            let html = '';
            
            operationItems.forEach((item, index) => {
                const inventoryItem = inventory.find(i => i.productId === item.productId);
                const currentStock = inventoryItem ? inventoryItem.currentStock : 0;
                const oldStock = item.oldStock || currentStock;
                const oldQuantity = item.quantity || 0;
                
                html += `
                    <div class="batch-operation-item">
                        <div class="batch-operation-item-header">
                            <div class="batch-operation-item-name">
                                ${item.productName} (${item.sku})
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 8px; align-items: center;">
                            <div style="flex: 1;">
                                <label class="form-label">原${historyItem.action === 'stock_in' ? '入库' : '出库'}数量</label>
                                <input type="number" class="form-control" value="${oldQuantity}" readonly>
                            </div>
                            <div style="flex: 1;">
                                <label class="form-label">新${historyItem.action === 'stock_in' ? '入库' : '出库'}数量</label>
                                <input type="number" class="form-control edit-operation-quantity" 
                                       value="${oldQuantity}" min="1" 
                                       data-index="${index}" 
                                       data-product-id="${item.productId}"
                                       data-product-name="${item.productName}"
                                       data-product-sku="${item.sku}"
                                       ${historyItem.action === 'stock_out' ? `max="${currentStock + oldQuantity}"` : ''}>
                            </div>
                        </div>
                        <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                            当前库存: ${currentStock}，原操作前库存: ${oldStock}
                        </div>
                    </div>
                `;
            });
            
            itemsContainer.innerHTML = html;
            modal.classList.add('active');
        }
        
        // 保存编辑的出入库操作
        function saveEditStockOperation() {
            if (!editingHistoryItem) {
                showToast('未找到要编辑的历史记录', 'error');
                return;
            }
            
            const remarkInput = document.getElementById('editStockOperationRemark');
            const quantityInputs = document.querySelectorAll('.edit-operation-quantity');
            
            const operationItems = editingHistoryItem.operationItems || [];
            const newOperationItems = [];
            let hasError = false;
            
            // 验证新数量
            quantityInputs.forEach(input => {
                const index = parseInt(input.dataset.index);
                const productId = input.dataset.productId;
                const productName = input.dataset.productName;
                const sku = input.dataset.productSku;
                const newQuantity = parseInt(input.value) || 0;
                
                if (newQuantity < 1) {
                    showToast('数量必须大于0', 'error');
                    hasError = true;
                    return;
                }
                
                let originalItem = operationItems[index];
                
                // 如果 originalItem 不存在，创建一个新的
                if (!originalItem) {
                    originalItem = {
                        productId: productId,
                        productName: productName,
                        sku: sku,
                        oldStock: 0,
                        newStock: 0,
                        quantity: 0
                    };
                }
                
                const inventoryItem = inventory.find(i => i.productId === productId);
                if (!inventoryItem) {
                    showToast(`找不到商品: ${productName} (${sku})`, 'error');
                    hasError = true;
                    return;
                }
                
                // 检查出库数量是否超过可用库存
                if (editingHistoryItem.action === 'stock_out') {
                    // 计算可用库存：当前库存 + 原出库数量
                    const availableStock = inventoryItem.currentStock + originalItem.quantity;
                    if (newQuantity > availableStock) {
                        showToast(`出库数量不能超过可用库存: ${productName} (${sku})，可用: ${availableStock}`, 'error');
                        hasError = true;
                        return;
                    }
                }
                
                newOperationItems.push({
                    ...originalItem,
                    productId: productId,
                    productName: productName,
                    sku: sku,
                    newQuantity: newQuantity
                });
            });
            
            if (hasError) return;
            
            // 更新库存
            let editDetails = '';
            newOperationItems.forEach(item => {
                const inventoryItem = inventory.find(i => i.productId === item.productId);
                if (inventoryItem) {
                    const originalQuantity = item.quantity || 0;
                    const newQuantity = item.newQuantity;
                    const difference = newQuantity - originalQuantity;
                    const oldStock = inventoryItem.currentStock;
                    
                    if (editingHistoryItem.action === 'stock_in') {
                        // 入库：调整差异
                        inventoryItem.currentStock += difference;
                    } else if (editingHistoryItem.action === 'stock_out') {
                        // 出库：调整差异（注意方向）
                        inventoryItem.currentStock -= difference;
                    }
                    
                    editDetails += `${item.productName} (${item.sku})，数量从 ${originalQuantity} 改为 ${newQuantity}，库存从 ${oldStock} 变为 ${inventoryItem.currentStock}; `;
                    
                    // 更新历史记录中的数量
                    item.quantity = newQuantity;
                    item.newStock = inventoryItem.currentStock;
                }
            });
            
            // 更新历史记录
            editingHistoryItem.details = `编辑${editingHistoryItem.action === 'stock_in' ? '入库' : '出库'}操作: ${editDetails}`;
            editingHistoryItem.remark = remarkInput.value;
            editingHistoryItem.operationItems = newOperationItems;
            editingHistoryItem.timestamp = new Date().toISOString();
            
            saveDataToStorage();
            renderInventoryGroups();
            updateSystemStats();
            updateOverview();
            closeEditStockOperationModal();
            
            // 立即更新历史记录显示
            if (currentTab === 'history') {
                renderHistory();
            }
            
            showToast('出入库操作已修改', 'success');
        }
        
        // 关闭编辑出入库操作模态框
        function closeEditStockOperationModal() {
            document.getElementById('editStockOperationModal').classList.remove('active');
            document.getElementById('editStockOperationItems').innerHTML = '';
            document.getElementById('editStockOperationRemark').value = '';
            editingHistoryItem = null;
        }
        
        // 应用历史筛选
        function applyHistoryFilters() {
            renderHistory();
            showToast("筛选已应用", "success");
        }
        
        // 清空历史筛选
        function clearHistoryFilters() {
            document.getElementById('historyStartDate').value = '';
            document.getElementById('historyEndDate').value = '';
            document.getElementById('historyActionType').value = '';
            renderHistory();
            showToast("筛选已清空", "success");
        }
        
        // 清理超过30天历史记录
        function cleanupOldHistory() {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            // 保留30天内的记录
            const newHistory = history.filter(item => {
                const itemDate = new Date(item.timestamp);
                return itemDate >= thirtyDaysAgo;
            });
            
            // 如果删除了记录，记录删除操作
            if (newHistory.length < history.length) {
                const deletedCount = history.length - newHistory.length;
                console.log(`清理了 ${deletedCount} 条超过30天的历史记录`);
                
                // 如果开启了自动清理，可以在这里添加一条清理记录
                if (deletedCount > 0) {
                    const cleanupHistory = {
                        id: generateId(),
                        action: 'system_cleanup',
                        target: '历史记录清理',
                        details: `自动清理了 ${deletedCount} 条超过30天的历史记录`,
                        timestamp: new Date().toISOString(),
                        user: '系统',
                        remark: '自动清理',
                        operationItems: []
                    };
                    newHistory.push(cleanupHistory);
                }
            }
            
            // 限制总记录数（可选，防止存储过大）
            const maxHistoryCount = 1000; // 最多保留1000条记录
            if (newHistory.length > maxHistoryCount) {
                newHistory.splice(0, newHistory.length - maxHistoryCount);
            }
            
            history = newHistory;
            saveDataToStorage();
        }
        
        // 更新系统统计信息
        function updateSystemStats() {
            document.getElementById('totalProducts').textContent = products.length;
            document.getElementById('totalInventory').textContent = inventory.length;
            document.getElementById('totalHistory').textContent = history.length;
        }
        
        // 更新数据总览
        function updateOverview() {
            // 统计库存状态
            let inStockCount = 0;
            let outOfStockCount = 0;
            let lowStockCount = 0;
            
            inventory.forEach(item => {
                if (item.currentStock === 0) {
                    outOfStockCount++;
                } else if (item.currentStock < item.warningValue) {
                    lowStockCount++;
                } else {
                    inStockCount++;
                }
            });
            
            // 统计今日操作
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayOperations = history.filter(item => 
                new Date(item.timestamp) >= today
            ).length;
            
            // 更新总览统计数据
            document.getElementById('overviewTotalProducts').textContent = products.length;
            document.getElementById('overviewTotalInventory').textContent = inventory.length;
            document.getElementById('overviewInStock').textContent = inStockCount;
            document.getElementById('overviewOutOfStock').textContent = outOfStockCount;
            document.getElementById('overviewLowStock').textContent = lowStockCount;
            document.getElementById('overviewTodayOperations').textContent = todayOperations;
            
            // 更新库存预警和缺货列表
            updateLowStockList();
            updateOutOfStockList();
            
            // 移除图表更新代码
        }
        
        // 更新库存预警列表（支持点击跳转）
        function updateLowStockList() {
            const lowStockList = document.getElementById('lowStockList');
            const lowStockCountElement = document.getElementById('lowStockCount');
            
            // 获取库存预警商品（库存低于预警值但大于0）
            const lowStockItems = inventory.filter(item => 
                item.currentStock > 0 && item.currentStock < item.warningValue
            ).sort((a, b) => a.currentStock - b.currentStock);
            
            lowStockCountElement.textContent = lowStockItems.length;
            
            if (lowStockItems.length === 0) {
                lowStockList.innerHTML = '<div class="no-data">暂无库存预警商品</div>';
                return;
            }
            
            let html = '';
            lowStockItems.forEach(item => {
                html += `
                    <div class="overview-list-item clickable-item">
                        <div class="overview-list-item-info">
                            <div class="overview-list-item-name">${item.productName}</div>
                            <div class="overview-list-item-sku">${item.productSku}</div>
                        </div>
                        <div class="overview-list-item-status">
                            <span class="badge badge-warning">库存: ${item.currentStock} / 预警值: ${item.warningValue}</span>
                        </div>
                    </div>
                `;
            });
            
            lowStockList.innerHTML = html;
        }
        
        // 更新缺货列表（支持点击跳转）
        function updateOutOfStockList() {
            const outOfStockList = document.getElementById('outOfStockList');
            const outOfStockCountElement = document.getElementById('outOfStockCount');
            
            // 获取缺货商品（库存为0）
            const outOfStockItems = inventory.filter(item => 
                item.currentStock === 0
            ).sort((a, b) => a.productName.localeCompare(b.productName));
            
            outOfStockCountElement.textContent = outOfStockItems.length;
            
            if (outOfStockItems.length === 0) {
                outOfStockList.innerHTML = '<div class="no-data">暂无缺货商品</div>';
                return;
            }
            
            let html = '';
            outOfStockItems.forEach(item => {
                html += `
                    <div class="overview-list-item clickable-item">
                        <div class="overview-list-item-info">
                            <div class="overview-list-item-name">${item.productName}</div>
                            <div class="overview-list-item-sku">${item.productSku}</div>
                        </div>
                        <div class="overview-list-item-status">
                            <span class="badge badge-danger">缺货</span>
                        </div>
                    </div>
                `;
            });
            
            outOfStockList.innerHTML = html;
        }
        
        // 填充产品选择框
        function populateProductSelects() {
            // 填充批量添加到库存选择框
            const batchAddInventoryProductSelect = document.getElementById('batchAddInventoryProductSelect');
            
            // 清空选择框
            batchAddInventoryProductSelect.innerHTML = '<option value="">请选择商品</option>';
            
            // 过滤出不在库存中的商品
            const productsNotInInventory = products.filter(product => 
                !inventory.some(item => item.productId === product.id)
            );
            
            // 批量添加选择框
            productsNotInInventory.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} (${product.sku})`;
                batchAddInventoryProductSelect.appendChild(option);
            });
        }
        
        // 打开添加/编辑商品模态框 - 修改：添加库存预警值字段
        function openProductModal(productId = null) {
            const modal = document.getElementById('productModal');
            const form = document.getElementById('productForm');
            const modalTitle = document.getElementById('productModalTitle');
            const imagePreview = document.getElementById('productImagePreview');
            
            // 关闭操作按钮折叠区域
            document.getElementById('toggleButtons').classList.remove('active');
            
            // 重置表单
            form.reset();
            imagePreview.style.display = 'none';
            
            // 设置默认预警值
            document.getElementById('productWarningValue').value = 5;
            
            if (productId) {
                // 编辑模式
                modalTitle.textContent = '编辑商品';
                editingProductId = productId;
                
                const product = products.find(p => p.id === productId);
                if (product) {
                    document.getElementById('productId').value = product.id;
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productSKU').value = product.sku;
                    document.getElementById('productType').value = product.type;
                    document.getElementById('productSetContent').value = product.setContent || '';
                    document.getElementById('productImage').value = product.imageUrl || '';
                    document.getElementById('productRemark').value = product.remark || '';
                    
                    // 检查商品是否在库存中，如果在，获取库存预警值
                    const inventoryItem = inventory.find(item => item.productId === productId);
                    if (inventoryItem) {
                        document.getElementById('productWarningValue').value = inventoryItem.warningValue;
                    }
                    
                    // 显示/隐藏套装内容字段
                    document.getElementById('setContentGroup').style.display = product.type === 'set' ? 'block' : 'none';
                    
                    // 显示图片预览
                    if (product.imageUrl && isValidURL(product.imageUrl)) {
                        imagePreview.src = product.imageUrl;
                        imagePreview.style.display = 'block';
                    }
                }
            } else {
                // 添加模式
                modalTitle.textContent = '添加商品';
                editingProductId = null;
                document.getElementById('productId').value = '';
                document.getElementById('setContentGroup').style.display = 'none';
            }
            
            modal.classList.add('active');
        }
        
        // 关闭商品模态框
        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
        }
        
        // 保存商品 - 修改：添加库存预警值处理
        function saveProduct() {
            const form = document.getElementById('productForm');
            if (!form.checkValidity()) {
                showToast('请填写所有必填字段', 'error');
                return;
            }
            
            const productData = {
                id: document.getElementById('productId').value || generateId(),
                name: document.getElementById('productName').value.trim(),
                sku: document.getElementById('productSKU').value.trim(),
                type: document.getElementById('productType').value,
                imageUrl: document.getElementById('productImage').value.trim(),
                setContent: document.getElementById('productSetContent').value.trim(),
                stock: 0, // 商品数据中不保存库存数量
                stockHistory: [],
                remark: document.getElementById('productRemark').value.trim(),
                createdAt: new Date().toISOString()
            };
            
            // 获取预警值
            const warningValue = parseInt(document.getElementById('productWarningValue').value) || 5;
            
            if (warningValue < 1) {
                showToast('预警值必须大于0', 'error');
                return;
            }
            
            // 如果是编辑模式
            if (editingProductId) {
                const index = products.findIndex(p => p.id === editingProductId);
                if (index !== -1) {
                    // 保留原有的创建时间和库存历史
                    productData.createdAt = products[index].createdAt;
                    products[index] = productData;
                    
                    // 更新库存中对应的商品信息和预警值
                    let inventoryUpdated = false;
                    inventory.forEach(item => {
                        if (item.productId === editingProductId) {
                            item.productName = productData.name;
                            item.productSku = productData.sku;
                            item.productImage = productData.imageUrl;
                            item.warningValue = warningValue;
                            inventoryUpdated = true;
                        }
                    });
                    
                    // 如果没有库存记录但用户设置了预警值，创建一个库存记录
                    if (!inventoryUpdated && warningValue !== 5) {
                        const inventoryItem = {
                            id: generateId(),
                            productId: productData.id,
                            productName: productData.name,
                            productSku: productData.sku,
                            productImage: productData.imageUrl,
                            currentStock: 0,
                            warningValue: warningValue,
                            remark: '通过编辑商品时创建',
                            createdAt: new Date().toISOString()
                        };
                        
                        inventory.push(inventoryItem);
                        inventoryUpdated = true;
                    }
                    
                    // 添加历史记录
                    let historyDetails = `编辑了商品: ${productData.name} (${productData.sku})`;
                    if (inventoryUpdated) {
                        historyDetails += `，预警值设置为: ${warningValue}`;
                    }
                    
                    addHistory('product_edit', productData.name, historyDetails, productData.remark);
                    showToast('商品编辑成功' + (inventoryUpdated ? '，库存预警值已更新' : ''), 'success');
                }
            } else {
                // 添加模式
                products.push(productData);
                
                // 如果预警值不是默认值5，创建一个库存记录
                if (warningValue !== 5) {
                    const inventoryItem = {
                        id: generateId(),
                        productId: productData.id,
                        productName: productData.name,
                        productSku: productData.sku,
                        productImage: productData.imageUrl,
                        currentStock: 0,
                        warningValue: warningValue,
                        remark: '通过添加商品时创建',
                        createdAt: new Date().toISOString()
                    };
                    
                    inventory.push(inventoryItem);
                }
                
                // 添加历史记录
                let historyDetails = `添加了新商品: ${productData.name} (${productData.sku})`;
                if (warningValue !== 5) {
                    historyDetails += `，预警值设置为: ${warningValue}`;
                }
                
                addHistory('product_add', productData.name, historyDetails, productData.remark);
                showToast('商品添加成功' + (warningValue !== 5 ? '，库存预警值已设置' : ''), 'success');
            }
            
            saveDataToStorage();
            renderProductsGroups();
            renderInventoryGroups();
            populateProductSelects();
            updateSystemStats();
            updateOverview();
            closeProductModal();
        }
        
        // 编辑商品
        function editProduct(productId) {
            openProductModal(productId);
        }
        
        // 删除商品
        function deleteProduct(productId) {
            if (!confirm('确定要删除这个商品吗？如果该商品在库存管理中，也将被移除。')) {
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            // 从商品列表中删除
            const productIndex = products.findIndex(p => p.id === productId);
            products.splice(productIndex, 1);
            
            // 从库存中删除（如果存在）
            const inventoryIndex = inventory.findIndex(item => item.productId === productId);
            if (inventoryIndex !== -1) {
                inventory.splice(inventoryIndex, 1);
            }
            
            // 添加历史记录
            addHistory('product_delete', product.name, `删除了商品: ${product.name} (${product.sku})`, '');
            
            saveDataToStorage();
            renderProductsGroups();
            renderInventoryGroups();
            populateProductSelects();
            updateSystemStats();
            updateOverview();
            showToast('商品删除成功', 'success');
        }
        
        // 将商品添加到库存
        function addProductToInventory(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            // 检查是否已在库存中
            if (inventory.some(item => item.productId === productId)) {
                showToast('该商品已在库存管理中', 'error');
                return;
            }
            
            openSingleAddToInventoryModal(productId);
        }
        
        // 打开添加到库存模态框（支持多选和数量设置）
        function openAddToInventoryModal(preSelectedIds = []) {
            const modal = document.getElementById('addToInventoryModal');
            
            // 关闭操作按钮折叠区域
            document.getElementById('toggleButtons').classList.remove('active');
            
            // 清空搜索框
            document.getElementById('addInventorySearch').value = '';
            
            // 填充商品列表
            populateAddInventoryItems(preSelectedIds);
            
            modal.classList.add('active');
        }
        
        // 填充添加到库存商品列表（支持一二级分组和搜索）
        function populateAddInventoryItems(preSelectedIds = []) {
            const addInventoryItems = document.getElementById('addInventoryItems');
            const searchTerm = document.getElementById('addInventorySearch').value.toLowerCase();
            
            // 过滤出不在库存中的商品
            const productsNotInInventory = products.filter(product => 
                !inventory.some(item => item.productId === product.id)
            );
            
            if (productsNotInInventory.length === 0) {
                addInventoryItems.innerHTML = '<div class="no-data">所有商品都已添加到库存中</div>';
                return;
            }
            
            // 按商品名称分组
            const groupedProducts = {};
            productsNotInInventory.forEach(product => {
                if (searchTerm) {
                    // 搜索过滤
                    if (!product.name.toLowerCase().includes(searchTerm) && 
                        !product.sku.toLowerCase().includes(searchTerm)) {
                        return;
                    }
                }
                
                if (!groupedProducts[product.name]) {
                    groupedProducts[product.name] = [];
                }
                groupedProducts[product.name].push(product);
            });
            
            let html = '';
            const productNames = Object.keys(groupedProducts);
            
            if (productNames.length === 0) {
                html = '<div class="no-data">没有找到匹配的商品</div>';
            } else {
                productNames.forEach(productName => {
                    const items = groupedProducts[productName];
                    const groupId = `add-inventory-group-${productName.replace(/\s+/g, '-')}`;
                    
                    html += `
                        <div class="inventory-group">
                            <div class="inventory-group-header collapsed" data-group="${groupId}">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-chevron-right"></i>
                                    <span>${productName}</span>
                                    <span class="badge badge-info">${items.length} 个型号</span>
                                </div>
                            </div>
                            <div class="inventory-group-items collapsed" id="${groupId}">
                    `;
                    
                    items.forEach(product => {
                        const isSelected = preSelectedIds.includes(product.id);
                        html += `
                            <div class="batch-operation-item">
                                <div class="batch-operation-item-header">
                                    <div class="batch-operation-item-name">
                                        ${product.imageUrl ? 
                                            `<img src="${product.imageUrl}" alt="${product.name}" class="product-image-small">` : 
                                            ''
                                        }
                                        ${product.sku}
                                    </div>
                                    <div class="batch-operation-item-controls">
                                        <input type="checkbox" class="product-checkbox" value="${product.id}" ${isSelected ? 'checked' : ''}>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px; margin-top: 8px;">
                                    <div style="flex: 1;">
                                        <label class="form-label">初始库存</label>
                                        <input type="number" class="form-control initial-stock" value="0" min="0" data-product-id="${product.id}">
                                    </div>
                                    <div style="flex: 1;">
                                        <label class="form-label">预警值</label>
                                        <input type="number" class="form-control warning-value" value="5" min="1" data-product-id="${product.id}">
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
            }
            
            addInventoryItems.innerHTML = html;
            
            // 添加折叠/展开事件监听器
            document.querySelectorAll('#addInventoryItems .inventory-group-header').forEach(header => {
                header.addEventListener('click', function() {
                    const groupId = this.getAttribute('data-group');
                    const groupItems = document.getElementById(groupId);
                    
                    if (groupItems.classList.contains('collapsed')) {
                        groupItems.classList.remove('collapsed');
                        this.classList.remove('collapsed');
                        this.querySelector('i').className = 'fas fa-chevron-down';
                    } else {
                        groupItems.classList.add('collapsed');
                        this.classList.add('collapsed');
                        this.querySelector('i').className = 'fas fa-chevron-right';
                    }
                });
            });
        }
        
        // 关闭添加到库存模态框
        function closeAddToInventoryModal() {
            document.getElementById('addToInventoryModal').classList.remove('active');
            document.getElementById('addInventoryItems').innerHTML = '';
            document.getElementById('addInventorySearch').value = '';
        }
        
        // 保存到库存（多选版本）
        function addToInventory() {
            const checkboxes = document.querySelectorAll('#addInventoryItems .product-checkbox:checked');
            
            if (checkboxes.length === 0) {
                showToast('请至少选择一个商品', 'error');
                return;
            }
            
            let addedCount = 0;
            const operationItems = [];
            
            checkboxes.forEach(checkbox => {
                const productId = checkbox.value;
                const product = products.find(p => p.id === productId);
                
                if (product && !inventory.some(item => item.productId === productId)) {
                    const initialStockInput = document.querySelector(`#addInventoryItems .initial-stock[data-product-id="${productId}"]`);
                    const warningValueInput = document.querySelector(`#addInventoryItems .warning-value[data-product-id="${productId}"]`);
                    
                    const initialStock = parseInt(initialStockInput?.value) || 0;
                    const warningValue = parseInt(warningValueInput?.value) || 5;
                    
                    const inventoryItem = {
                        id: generateId(),
                        productId: product.id,
                        productName: product.name,
                        productSku: product.sku,
                        productImage: product.imageUrl,
                        currentStock: initialStock,
                        warningValue: warningValue,
                        remark: '从批量添加中导入',
                        createdAt: new Date().toISOString()
                    };
                    
                    inventory.push(inventoryItem);
                    operationItems.push({
                        productId: product.id,
                        productName: product.name,
                        sku: product.sku,
                        oldStock: 0,
                        newStock: initialStock,
                        quantity: initialStock
                    });
                    addedCount++;
                }
            });
            
            if (addedCount > 0) {
                // 添加历史记录
                addHistory('inventory_add', `批量添加 ${addedCount} 个商品`, `批量添加了 ${addedCount} 个商品到库存管理`, '批量添加', operationItems);
                
                saveDataToStorage();
                renderProductsGroups();
                renderInventoryGroups();
                populateProductSelects();
                updateSystemStats();
                updateOverview();
                closeAddToInventoryModal();
                showToast(`成功添加 ${addedCount} 个商品到库存`, 'success');
            } else {
                showToast('没有成功添加任何商品到库存', 'warning');
            }
        }
        
        // 批量添加到库存
        function batchAddToInventory() {
            const selectElement = document.getElementById('batchAddInventoryProductSelect');
            const selectedOptions = Array.from(selectElement.selectedOptions);
            
            if (selectedOptions.length === 0) {
                showToast('请至少选择一个商品', 'error');
                return;
            }
            
            const warningValue = parseInt(document.getElementById('batchInventoryWarningValue').value) || 5;
            const remark = document.getElementById('batchAddInventoryRemark').value.trim();
            
            let addedCount = 0;
            const operationItems = [];
            
            selectedOptions.forEach(option => {
                const productId = option.value;
                const product = products.find(p => p.id === productId);
                
                if (product && !inventory.some(item => item.productId === productId)) {
                    const inventoryItem = {
                        id: generateId(),
                        productId: product.id,
                        productName: product.name,
                        productSku: product.sku,
                        productImage: product.imageUrl,
                        currentStock: 0,
                        warningValue: warningValue,
                        remark: remark || '从批量添加中导入',
                        createdAt: new Date().toISOString()
                    };
                    
                    inventory.push(inventoryItem);
                    operationItems.push({
                        productId: product.id,
                        productName: product.name,
                        sku: product.sku,
                        oldStock: 0,
                        newStock: 0,
                        quantity: 0
                    });
                    addedCount++;
                }
            });
            
            if (addedCount > 0) {
                // 添加历史记录
                addHistory('inventory_add', `批量添加 ${addedCount} 个商品`, `批量添加了 ${addedCount} 个商品到库存管理，预警值: ${warningValue}`, remark, operationItems);
                
                saveDataToStorage();
                renderProductsGroups();
                renderInventoryGroups();
                populateProductSelects();
                updateSystemStats();
                updateOverview();
                closeBatchAddToInventoryModal();
                showToast(`成功添加 ${addedCount} 个商品到库存`, 'success');
            } else {
                showToast('没有成功添加任何商品到库存', 'warning');
            }
        }
        
        // 关闭批量添加到库存模态框
        function closeBatchAddToInventoryModal() {
            document.getElementById('batchAddToInventoryModal').classList.remove('active');
            document.getElementById('batchAddInventoryProductSelect').selectedIndex = -1;
            document.getElementById('batchInventoryWarningValue').value = 5;
            document.getElementById('batchAddInventoryRemark').value = '';
        }
        
        // 打开库存盘点模态框（支持多选）
        function openStockCheckModal() {
            if (inventory.length === 0) {
                showToast('库存中没有商品，请先添加商品到库存', 'error');
                return;
            }
            
            const modal = document.getElementById('stockCheckModal');
            
            document.getElementById('toggleButtons').classList.remove('active');
            document.getElementById('stockCheckResult').style.display = 'none';
            
            // 清空搜索框
            document.getElementById('stockCheckSearch').value = '';
            
            // 填充商品列表
            populateStockCheckItems();
            
            modal.classList.add('active');
        }
        
        // 填充库存盘点商品列表（支持一二级分组和搜索）
        function populateStockCheckItems() {
            const stockCheckItems = document.getElementById('stockCheckItems');
            const searchTerm = document.getElementById('stockCheckSearch').value.toLowerCase();
            
            // 按商品名称分组
            const groupedInventory = {};
            inventory.forEach(item => {
                if (searchTerm) {
                    // 搜索过滤
                    if (!item.productName.toLowerCase().includes(searchTerm) && 
                        !item.productSku.toLowerCase().includes(searchTerm)) {
                        return;
                    }
                }
                
                if (!groupedInventory[item.productName]) {
                    groupedInventory[item.productName] = [];
                }
                groupedInventory[item.productName].push(item);
            });
            
            let html = '';
            const productNames = Object.keys(groupedInventory);
            
            if (productNames.length === 0) {
                html = '<div class="no-data">没有找到匹配的商品</div>';
            } else {
                productNames.forEach(productName => {
                    const items = groupedInventory[productName];
                    const groupId = `stock-check-group-${productName.replace(/\s+/g, '-')}`;
                    
                    html += `
                        <div class="inventory-group">
                            <div class="inventory-group-header collapsed" data-group="${groupId}">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-chevron-right"></i>
                                    <span>${productName}</span>
                                    <span class="badge badge-info">${items.length} 个型号</span>
                                </div>
                            </div>
                            <div class="inventory-group-items collapsed" id="${groupId}">
                    `;
                    
                    items.forEach(item => {
                        html += `
                            <div class="batch-operation-item">
                                <div class="batch-operation-item-header">
                                    <div class="batch-operation-item-name">
                                        ${item.productImage ? 
                                            `<img src="${item.productImage}" alt="${item.productName}" class="product-image-small">` : 
                                            ''
                                        }
                                        ${item.productSku}
                                        <span class="badge ${getStockClass(item.currentStock, item.warningValue) === 'stock-normal' ? 'badge-success' : getStockClass(item.currentStock, item.warningValue) === 'stock-low' ? 'badge-warning' : 'badge-danger'}" style="margin-left: 8px;">
                                            当前: ${item.currentStock}
                                        </span>
                                    </div>
                                    <div class="batch-operation-item-controls">
                                        <input type="checkbox" class="product-checkbox" value="${item.id}">
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px; margin-top: 8px;">
                                    <div style="flex: 1;">
                                        <label class="form-label">当前库存</label>
                                        <input type="text" class="form-control current-stock" value="${item.currentStock}" readonly data-item-id="${item.id}">
                                    </div>
                                    <div style="flex: 1;">
                                        <label class="form-label">盘点后库存</label>
                                        <input type="number" class="form-control checked-stock" value="${item.currentStock}" min="0" data-item-id="${item.id}">
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
            }
            
            stockCheckItems.innerHTML = html;
            
            // 添加折叠/展开事件监听器
            document.querySelectorAll('#stockCheckItems .inventory-group-header').forEach(header => {
                header.addEventListener('click', function() {
                    const groupId = this.getAttribute('data-group');
                    const groupItems = document.getElementById(groupId);
                    
                    if (groupItems.classList.contains('collapsed')) {
                        groupItems.classList.remove('collapsed');
                        this.classList.remove('collapsed');
                        this.querySelector('i').className = 'fas fa-chevron-down';
                    } else {
                        groupItems.classList.add('collapsed');
                        this.classList.add('collapsed');
                        this.querySelector('i').className = 'fas fa-chevron-right';
                    }
                });
            });
        }
        
        // 关闭库存盘点模态框
        function closeStockCheckModal() {
            document.getElementById('stockCheckModal').classList.remove('active');
            document.getElementById('stockCheckItems').innerHTML = '';
            document.getElementById('stockCheckResult').style.display = 'none';
            document.getElementById('stockCheckSearch').value = '';
        }
        
        // 执行库存盘点（多选版本）
        function executeStockCheck() {
            const checkboxes = document.querySelectorAll('#stockCheckItems .product-checkbox:checked');
            
            if (checkboxes.length === 0) {
                showToast('请至少选择一个商品进行盘点', 'error');
                return;
            }
            
            let checkedCount = 0;
            let totalDifference = 0;
            let resultHtml = '';
            const operationItems = [];
            
            checkboxes.forEach(checkbox => {
                const itemId = checkbox.value;
                const item = inventory.find(i => i.id === itemId);
                
                if (item) {
                    const checkedStockInput = document.querySelector(`#stockCheckItems .checked-stock[data-item-id="${itemId}"]`);
                    const checkedStock = parseInt(checkedStockInput?.value) || 0;
                    
                    if (isNaN(checkedStock) || checkedStock < 0) {
                        showToast(`请输入有效的盘点后库存数量: ${item.productName}`, 'error');
                        return;
                    }
                    
                    const oldStock = item.currentStock;
                    const difference = checkedStock - oldStock;
                    item.currentStock = checkedStock;
                    
                    resultHtml += `
                        <div style="margin-bottom: 8px; padding: 8px; background-color: #f8f9fa; border-radius: 4px;">
                            <strong>${item.productName} (${item.productSku})</strong><br>
                            原库存: ${oldStock}，盘点后: ${checkedStock}，差异: 
                            <span class="${difference > 0 ? 'text-success' : difference < 0 ? 'text-danger' : 'text-info'}">
                                ${difference >= 0 ? '+' : ''}${difference}
                            </span>
                        </div>
                    `;
                    
                    operationItems.push({
                        productId: item.productId,
                        productName: item.productName,
                        sku: item.productSku,
                        oldStock: oldStock,
                        newStock: checkedStock,
                        quantity: Math.abs(difference)
                    });
                    
                    checkedCount++;
                    totalDifference += difference;
                }
            });
            
            if (checkedCount > 0) {
                // 显示盘点结果
                const resultDiv = document.getElementById('stockCheckResult');
                const messageDiv = document.getElementById('stockCheckMessage');
                
                let summaryHtml = '';
                if (totalDifference > 0) {
                    summaryHtml = `<div class="badge badge-success" style="font-size: 1rem; margin-bottom: 10px;">总盘盈: +${totalDifference}</div>`;
                } else if (totalDifference < 0) {
                    summaryHtml = `<div class="badge badge-danger" style="font-size: 1rem; margin-bottom: 10px;">总盘亏: ${totalDifference}</div>`;
                } else {
                    summaryHtml = `<div class="badge badge-info" style="font-size: 1rem; margin-bottom: 10px;">库存准确，无差异</div>`;
                }
                
                summaryHtml += `<p style="margin-top: 10px; font-size: 0.9rem;">共盘点 ${checkedCount} 个商品</p>`;
                summaryHtml += resultHtml;
                
                messageDiv.innerHTML = summaryHtml;
                resultDiv.style.display = 'block';
                
                // 添加历史记录
                addHistory('stock_check', `批量盘点 ${checkedCount} 个商品`, `批量库存盘点，共盘点 ${checkedCount} 个商品，总差异: ${totalDifference >= 0 ? '+' : ''}${totalDifference}`, '', operationItems);
                
                saveDataToStorage();
                renderInventoryGroups();
                updateSystemStats();
                updateOverview();
                
                // 2秒后关闭模态框
                setTimeout(() => {
                    closeStockCheckModal();
                    showToast(`库存盘点完成，共盘点 ${checkedCount} 个商品`, 'success');
                }, 2000);
            }
        }
        
        // 打开出入库操作模态框（支持多选）
        function openStockOperationModal(operationType = 'in') {
            if (inventory.length === 0) {
                showToast('库存中没有商品，请先添加商品到库存', 'error');
                return;
            }
            
            const modal = document.getElementById('stockOperationModal');
            
            document.getElementById('stockOperationType').value = operationType;
            document.getElementById('stockOperationTitle').textContent = operationType === 'in' ? '入库操作' : '出库操作';
            
            // 清空搜索框
            document.getElementById('stockOperationSearch').value = '';
            
            populateStockOperationItems();
            
            document.getElementById('toggleButtons').classList.remove('active');
            modal.classList.add('active');
        }
        
        // 填充出入库操作商品（多选版本，支持一二级分组和搜索）
        function populateStockOperationItems() {
            const stockOperationItems = document.getElementById('stockOperationItems');
            const operationType = document.getElementById('stockOperationType').value;
            const searchTerm = document.getElementById('stockOperationSearch').value.toLowerCase();
            
            // 如果是出库操作，只显示有库存的商品
            let filteredInventory = operationType === 'out' 
                ? inventory.filter(item => item.currentStock > 0)
                : inventory;
            
            // 应用搜索过滤
            if (searchTerm) {
                filteredInventory = filteredInventory.filter(item => 
                    item.productName.toLowerCase().includes(searchTerm) || 
                    item.productSku.toLowerCase().includes(searchTerm)
                );
            }
            
            if (filteredInventory.length === 0) {
                if (operationType === 'out') {
                    stockOperationItems.innerHTML = '<div class="no-data">没有找到匹配的有库存商品</div>';
                } else {
                    stockOperationItems.innerHTML = '<div class="no-data">没有找到匹配的商品</div>';
                }
                return;
            }
            
            // 按商品名称分组
            const groupedInventory = {};
            filteredInventory.forEach(item => {
                if (!groupedInventory[item.productName]) {
                    groupedInventory[item.productName] = [];
                }
                groupedInventory[item.productName].push(item);
            });
            
            let html = '';
            const productNames = Object.keys(groupedInventory);
            
            productNames.forEach(productName => {
                const items = groupedInventory[productName];
                const groupId = `stock-operation-group-${productName.replace(/\s+/g, '-')}`;
                
                html += `
                    <div class="inventory-group">
                        <div class="inventory-group-header collapsed" data-group="${groupId}">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-chevron-right"></i>
                                <span>${productName}</span>
                                <span class="badge badge-info">${items.length} 个型号</span>
                            </div>
                        </div>
                        <div class="inventory-group-items collapsed" id="${groupId}">
                `;
                
                items.forEach(item => {
                    const maxQuantity = operationType === 'out' ? item.currentStock : 9999;
                    
                    html += `
                        <div class="batch-operation-item">
                            <div class="batch-operation-item-header">
                                <div class="batch-operation-item-name">
                                    ${item.productImage ? 
                                        `<img src="${item.productImage}" alt="${item.productName}" class="product-image-small">` : 
                                        ''
                                    }
                                    ${item.productSku}
                                    <span class="badge ${getStockClass(item.currentStock, item.warningValue) === 'stock-normal' ? 'badge-success' : getStockClass(item.currentStock, item.warningValue) === 'stock-low' ? 'badge-warning' : 'badge-danger'}" style="margin-left: 8px;">
                                        当前: ${item.currentStock}
                                    </span>
                                </div>
                                <div class="batch-operation-item-controls">
                                    <input type="checkbox" class="product-checkbox" value="${item.id}">
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 8px; align-items: center;">
                                <div style="flex: 1;">
                                    <label class="form-label">${operationType === 'in' ? '入库' : '出库'}数量</label>
                                    <input type="number" class="form-control operation-quantity" value="1" min="1" max="${maxQuantity}" data-item-id="${item.id}">
                                </div>
                                <div style="margin-top: 24px;">
                                    <button type="button" class="quantity-btn" onclick="adjustOperationQuantity('${item.id}', -1)">-</button>
                                    <button type="button" class="quantity-btn" onclick="adjustOperationQuantity('${item.id}', 1)">+</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            stockOperationItems.innerHTML = html;
            
            // 添加折叠/展开事件监听器
            document.querySelectorAll('#stockOperationItems .inventory-group-header').forEach(header => {
                header.addEventListener('click', function() {
                    const groupId = this.getAttribute('data-group');
                    const groupItems = document.getElementById(groupId);
                    
                    if (groupItems.classList.contains('collapsed')) {
                        groupItems.classList.remove('collapsed');
                        this.classList.remove('collapsed');
                        this.querySelector('i').className = 'fas fa-chevron-down';
                    } else {
                        groupItems.classList.add('collapsed');
                        this.classList.add('collapsed');
                        this.querySelector('i').className = 'fas fa-chevron-right';
                    }
                });
            });
        }
        
        // 调整出入库操作数量
        function adjustOperationQuantity(itemId, change) {
            const input = document.querySelector(`#stockOperationItems .operation-quantity[data-item-id="${itemId}"]`);
            if (!input) return;
            
            const operationType = document.getElementById('stockOperationType').value;
            const item = inventory.find(i => i.id === itemId);
            
            if (!item) return;
            
            const maxQuantity = operationType === 'out' ? item.currentStock : 9999;
            let currentValue = parseInt(input.value) || 1;
            
            currentValue += change;
            
            if (currentValue < 1) currentValue = 1;
            if (currentValue > maxQuantity) currentValue = maxQuantity;
            
            input.value = currentValue;
        }
        
        // 关闭出入库操作模态框
        function closeStockOperationModal() {
            document.getElementById('stockOperationModal').classList.remove('active');
            document.getElementById('stockOperationItems').innerHTML = '';
            document.getElementById('stockOperationRemark').value = '';
            document.getElementById('stockOperationSearch').value = '';
        }
        
        // 执行出入库操作（多选版本，支持操作详情记录）
        function executeStockOperation() {
            const operationType = document.getElementById('stockOperationType').value;
            const checkboxes = document.querySelectorAll('#stockOperationItems .product-checkbox:checked');
            const remark = document.getElementById('stockOperationRemark').value.trim();
            
            if (checkboxes.length === 0) {
                showToast('请至少选择一个商品', 'error');
                return;
            }
            
            const operationText = operationType === 'in' ? '入库' : '出库';
            let operationDetails = '';
            let operationCount = 0;
            const operationItems = [];
            
            // 检查所有选中商品的数量是否有效
            let hasError = false;
            checkboxes.forEach(checkbox => {
                const itemId = checkbox.value;
                const item = inventory.find(i => i.id === itemId);
                
                if (item) {
                    const quantityInput = document.querySelector(`#stockOperationItems .operation-quantity[data-item-id="${itemId}"]`);
                    const quantity = quantityInput ? parseInt(quantityInput.value) || 1 : 1;
                    
                    if (operationType === 'out' && quantity > item.currentStock) {
                        showToast(`出库数量不能超过当前库存: ${item.productName} (${item.productSku})`, 'error');
                        hasError = true;
                    }
                }
            });
            
            if (hasError) return;
            
            // 执行操作
            checkboxes.forEach(checkbox => {
                const itemId = checkbox.value;
                const item = inventory.find(i => i.id === itemId);
                
                if (item) {
                    const quantityInput = document.querySelector(`#stockOperationItems .operation-quantity[data-item-id="${itemId}"]`);
                    const quantity = quantityInput ? parseInt(quantityInput.value) || 1 : 1;
                    
                    const oldStock = item.currentStock;
                    
                    if (operationType === 'in') {
                        item.currentStock += quantity;
                    } else {
                        item.currentStock -= quantity;
                    }
                    
                    operationDetails += `${item.productName} (${item.productSku})，数量: ${quantity}，库存从 ${oldStock} 变为 ${item.currentStock}; `;
                    operationItems.push({
                        productId: item.productId,
                        productName: item.productName,
                        sku: item.productSku,
                        oldStock: oldStock,
                        newStock: item.currentStock,
                        quantity: quantity
                    });
                    operationCount++;
                }
            });
            
            if (operationCount > 0) {
                // 添加历史记录（包含操作详情供撤销使用）
                addHistory(
                    operationType === 'in' ? 'stock_in' : 'stock_out', 
                    `批量${operationText}操作`, 
                    `${operationText}操作: ${operationDetails}`,
                    remark,
                    operationItems
                );
                
                saveDataToStorage();
                renderInventoryGroups();
                updateSystemStats();
                updateOverview();
                closeStockOperationModal();
                showToast(`${operationText}操作成功，共操作 ${operationCount} 个商品`, 'success');
            }
        }
        
        // 切换全选复选框
        function toggleAllCheckboxes(type) {
            const checkboxes = document.querySelectorAll(`#${type}Items .product-checkbox`);
            const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
        }
        
        // 添加历史记录（增强版，包含操作详情）
        function addHistory(action, target, details, remark, operationItems = []) {
            // 如果没有提供 operationItems，尝试从 details 中解析（用于历史数据兼容）
            let itemsToSave = operationItems;
            if (itemsToSave.length === 0 && details) {
                itemsToSave = parseOperationItemsFromDetails(details);
            }
            
            const historyItem = {
                id: generateId(),
                action: action,
                target: target,
                details: details,
                timestamp: new Date().toISOString(),
                user: '用户',
                remark: remark || '',
                operationItems: itemsToSave
            };
            
            history.push(historyItem);
            saveDataToStorage();
            
            // 清理超过30天的历史记录
            cleanupOldHistory();
            
            // 如果当前在历史标签页，更新显示
            if (currentTab === 'history') {
                renderHistory();
            }
            
            updateSystemStats();
            updateOverview();
        }
        
        // 导出所有数据
        function exportAllData() {
            try {
                // 创建工作簿
                const wb = XLSX.utils.book_new();
                
                // 创建商品数据工作表
                const productsData = products.map(product => ({
                    'ID': product.id,
                    '名称': product.name,
                    'SKU': product.sku,
                    '类型': product.type === 'set' ? '套装' : '单品',
                    '图片URL': product.imageUrl || '',
                    '套装内容': product.setContent || '',
                    '备注': product.remark || '',
                    '创建时间': new Date(product.createdAt).toLocaleString('zh-CN')
                }));
                
                const productsWs = XLSX.utils.json_to_sheet(productsData);
                XLSX.utils.book_append_sheet(wb, productsWs, '商品数据');
                
                // 创建库存数据工作表
                const inventoryData = inventory.map(item => ({
                    'ID': item.id,
                    '商品ID': item.productId,
                    '商品名称': item.productName,
                    '商品SKU': item.productSku,
                    '图片URL': item.productImage || '',
                    '当前库存': item.currentStock || 0,
                    '预警值': item.warningValue || 5,
                    '备注': item.remark || '',
                    '创建时间': new Date(item.createdAt).toLocaleString('zh-CN')
                }));
                
                const inventoryWs = XLSX.utils.json_to_sheet(inventoryData);
                XLSX.utils.book_append_sheet(wb, inventoryWs, '库存数据');
                
                // 创建历史记录工作表
                const historyData = history.map(item => ({
                    'ID': item.id,
                    '操作类型': item.action,
                    '目标': item.target,
                    '详情': item.details,
                    '备注': item.remark || '',
                    '操作时间': new Date(item.timestamp).toLocaleString('zh-CN'),
                    '操作人': item.user || '系统'
                }));
                
                const historyWs = XLSX.utils.json_to_sheet(historyData);
                XLSX.utils.book_append_sheet(wb, historyWs, '操作历史');
                
                // 导出Excel文件
                const fileName = `库存系统数据备份_${new Date().toLocaleString('sv-SE').replace(' ', '_').replace(/:/g, '-').slice(0, 19)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                // 添加历史记录
                addHistory('export', '所有数据', '导出了系统所有数据到Excel文件', '');
                
                showToast('数据导出成功', 'success');
            } catch (error) {
                console.error('导出数据时出错:', error);
                showToast('导出数据失败: ' + error.message, 'error');
            }
        }
        
        // 导出商品数据
        function exportProducts() {
            try {
                // 创建工作簿
                const wb = XLSX.utils.book_new();
                
                // 创建商品数据工作表
                const productsData = products.map(product => ({
                    'ID': product.id,
                    '名称': product.name,
                    'SKU': product.sku,
                    '类型': product.type === 'set' ? '套装' : '单品',
                    '图片URL': product.imageUrl || '',
                    '套装内容': product.setContent || '',
                    '备注': product.remark || '',
                    '创建时间': new Date(product.createdAt).toLocaleString('zh-CN')
                }));
                
                const productsWs = XLSX.utils.json_to_sheet(productsData);
                XLSX.utils.book_append_sheet(wb, productsWs, '商品数据');
                
                // 导出Excel文件
                const fileName = `商品数据(库存系统)_${new Date().toLocaleString('sv-SE').replace(' ', '_').replace(/:/g, '-').slice(0, 19)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                // 添加历史记录
                addHistory('export', '商品数据', '导出了商品数据到Excel文件', '');
                
                showToast('商品数据导出成功', 'success');
            } catch (error) {
                console.error('导出商品数据时出错:', error);
                showToast('导出商品数据失败: ' + error.message, 'error');
            }
        }
        
        // 导入商品数据
        function importProducts() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // 读取第一个工作表
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        let importedCount = 0;
                        let updatedCount = 0;
                        
                        jsonData.forEach(item => {
                            // 检查是否已存在相同ID的商品
                            const existingIndex = products.findIndex(p => p.id == item.ID);
                            
                            const productData = {
                                id: item.ID || generateId(),
                                name: item.名称 || '',
                                sku: item.SKU || '',
                                type: item.类型 === '套装' ? 'set' : 'product',
                                imageUrl: item.图片URL || '',
                                setContent: item.套装内容 || '',
                                stock: 0, // 商品数据中不保存库存数量
                                stockHistory: [],
                                remark: item.备注 || '',
                                createdAt: item.创建时间 ? new Date(item.创建时间).toISOString() : new Date().toISOString()
                            };
                            
                            if (existingIndex !== -1) {
                                // 更新现有商品
                                products[existingIndex] = productData;
                                updatedCount++;
                            } else {
                                // 添加新商品
                                products.push(productData);
                                importedCount++;
                            }
                        });
                        
                        saveDataToStorage();
                        renderProductsGroups();
                        populateProductSelects();
                        updateSystemStats();
                        updateOverview();
                        
                        // 添加历史记录
                        addHistory('import', '商品数据', `导入了商品数据，新增: ${importedCount}，更新: ${updatedCount}`, '');
                        
                        showToast(`商品数据导入成功！新增: ${importedCount}，更新: ${updatedCount}`, 'success');
                    } catch (error) {
                        console.error('导入商品数据时出错:', error);
                        showToast('导入商品数据失败: ' + error.message, 'error');
                    }
                };
                
                reader.readAsArrayBuffer(file);
            };
            
            input.click();
        }
        
        // 导入所有数据（优化版，修复Excel识别问题）- 修复：只识别自己的数据
        function importAllData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    let importedProducts = 0;
                    let importedInventory = 0;
                    let importedHistory = 0;
                    
                    // 检查是否是我们系统的数据格式
                    const sheetNames = workbook.SheetNames;
                    const isOurSystemData = sheetNames.includes('商品数据') || 
                                            sheetNames.includes('库存数据') || 
                                            sheetNames.includes('操作历史');
                    
                    if (!isOurSystemData) {
                        showToast('这不是本系统的数据文件，请导入正确的数据文件', 'error');
                        event.target.value = '';
                        return;
                    }
                    
                    // 导入商品数据
                    if (workbook.SheetNames.includes('商品数据')) {
                        const worksheet = workbook.Sheets['商品数据'];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        jsonData.forEach(item => {
                            // 检查是否已存在相同ID的商品
                            const existingIndex = products.findIndex(p => p.id == item.ID);
                            
                            const productData = {
                                id: item.ID || generateId(),
                                name: item.名称 || item.name || '',
                                sku: item.SKU || item.sku || '',
                                type: (item.类型 || item.type) === '套装' ? 'set' : 'product',
                                imageUrl: item.图片URL || item.imageUrl || '',
                                setContent: item.套装内容 || item.setContent || '',
                                stock: 0,
                                stockHistory: [],
                                remark: item.备注 || item.remark || '',
                                createdAt: (item.创建时间 || item.createdAt) ? 
                                    new Date(item.创建时间 || item.createdAt).toISOString() : 
                                    new Date().toISOString()
                            };
                            
                            if (existingIndex !== -1) {
                                products[existingIndex] = productData;
                            } else {
                                products.push(productData);
                            }
                            importedProducts++;
                        });
                    }
                    
                    // 导入库存数据
                    if (workbook.SheetNames.includes('库存数据')) {
                        const worksheet = workbook.Sheets['库存数据'];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        inventory = []; // 清空现有库存数据
                        
                        jsonData.forEach(item => {
                            const inventoryItem = {
                                id: item.ID || generateId(),
                                productId: item.商品ID || item.productId || '',
                                productName: item.商品名称 || item.productName || '',
                                productSku: item.商品SKU || item.productSku || '',
                                productImage: item.图片URL || item.productImage || '',
                                currentStock: parseInt(item.当前库存 || item.currentStock) || 0,
                                warningValue: parseInt(item.预警值 || item.warningValue) || 5,
                                remark: item.备注 || item.remark || '',
                                createdAt: (item.创建时间 || item.createdAt) ? 
                                    new Date(item.创建时间 || item.createdAt).toISOString() : 
                                    new Date().toISOString()
                            };
                            
                            inventory.push(inventoryItem);
                            importedInventory++;
                        });
                    }
                    
                    // 导入历史记录数据
                    if (workbook.SheetNames.includes('操作历史')) {
                        const worksheet = workbook.Sheets['操作历史'];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        history = []; // 清空现有历史记录
                        
                        jsonData.forEach(item => {
                            const historyItem = {
                                id: item.ID || generateId(),
                                action: item.操作类型 || item.action || '',
                                target: item.目标 || item.target || '',
                                details: item.详情 || item.details || '',
                                timestamp: (item.操作时间 || item.timestamp) ? 
                                    new Date(item.操作时间 || item.timestamp).toISOString() : 
                                    new Date().toISOString(),
                                user: item.操作人 || item.user || '系统',
                                remark: item.备注 || item.remark || ''
                            };
                            
                            history.push(historyItem);
                            importedHistory++;
                        });
                    }
                    
                    saveDataToStorage();
                    renderProductsGroups();
                    renderInventoryGroups();
                    renderHistory();
                    populateProductSelects();
                    updateSystemStats();
                    updateOverview();
                    
                    // 添加历史记录
                    addHistory('import', '所有数据', `导入了系统所有数据，商品: ${importedProducts}，库存: ${importedInventory}，历史: ${importedHistory}`, '');
                    
                    showToast(`数据导入成功！商品: ${importedProducts}，库存: ${importedInventory}，历史: ${importedHistory}`, 'success');
                    
                    // 重置文件输入
                    event.target.value = '';
                } catch (error) {
                    console.error('导入数据时出错:', error);
                    showToast('导入数据失败: ' + error.message, 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // 重置系统 - 安全版本，只清除本程序数据
        function resetSystem() {
            const password = document.getElementById('resetPassword').value;
            if (password !== '123456') {
                showToast('重置密码错误，请输入正确的密码', 'error');
                return;
            }
            
            if (!confirm('确定要重置系统吗？这将清除本程序所有数据，且不可恢复！\n\n注意：此操作只会清除本程序数据，不会影响其他程序数据。')) {
                return;
            }
            
            // 安全清除本程序数据
            clearProgramDataOnly();
            
            // 重置内存中的数据
            products = [];
            inventory = [];
            history = [];
            columnSettings = {
                showImage: true,
                showType: true,
                showRemark: true
            };
            
            // 重置UI
            renderProductsGroups();
            renderInventoryGroups();
            renderHistory();
            populateProductSelects();
            updateSystemStats();
            updateOverview();
            
            // 清空密码输入框
            document.getElementById('resetPassword').value = '';
            
            // 添加历史记录
            addHistory('system_reset', '系统', '重置了系统，清除了所有数据', '安全重置，不影响其他程序数据');
            
            showToast('系统已安全重置，本程序数据已清除（不影响其他程序）', 'success');
        }
        
        // 查看图片全屏
        function viewImageFullscreen(imageUrl) {
            if (!imageUrl) return;
            
            const fullscreenImg = document.getElementById('fullscreenImage');
            fullscreenImg.src = imageUrl;
            document.getElementById('fullscreenImageModal').classList.add('active');
        }
        
        // 显示提示消息
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast toast-${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // 获取库存状态
        function getStockStatus(stock, warningValue = 5) {
            if (stock === 0) return '缺货';
            if (stock < warningValue) return '库存低';
            return '正常';
        }
        
        // 获取库存状态类名
        function getStockClass(stock, warningValue = 5) {
            if (stock === 0) return 'stock-out';
            if (stock < warningValue) return 'stock-low';
            return 'stock-normal';
        }
        
        // 验证URL
        function isValidURL(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>